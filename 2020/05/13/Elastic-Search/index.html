<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.2',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="目录 Elasticsearch: 权威指南注意ES6.x  移除string，新增text及keyword，并且mappings中index参数为布尔值 移除missing    目录 基础入门 安装运行 特性 交互语句 数据操作 元数据 检查文档: HEAD 索引文档: PUT或POST 新建文档: PUT /URL/_creat或POST 更新文档: PUT 部分更新: POST /URL/">
<meta name="keywords" content="大数据">
<meta property="og:type" content="article">
<meta property="og:title" content="Elastic Search">
<meta property="og:url" content="http://yoursite.com/2020/05/13/Elastic-Search/index.html">
<meta property="og:site_name" content="LOUIS&#39; BLOG">
<meta property="og:description" content="目录 Elasticsearch: 权威指南注意ES6.x  移除string，新增text及keyword，并且mappings中index参数为布尔值 移除missing    目录 基础入门 安装运行 特性 交互语句 数据操作 元数据 检查文档: HEAD 索引文档: PUT或POST 新建文档: PUT /URL/_creat或POST 更新文档: PUT 部分更新: POST /URL/">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-05-18T01:49:01.439Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elastic Search">
<meta name="twitter:description" content="目录 Elasticsearch: 权威指南注意ES6.x  移除string，新增text及keyword，并且mappings中index参数为布尔值 移除missing    目录 基础入门 安装运行 特性 交互语句 数据操作 元数据 检查文档: HEAD 索引文档: PUT或POST 新建文档: PUT /URL/_creat或POST 更新文档: PUT 部分更新: POST /URL/">






  <link rel="canonical" href="http://yoursite.com/2020/05/13/Elastic-Search/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Elastic Search | LOUIS' BLOG</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LOUIS' BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">To be better</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-guestbook">
    <a href="/guestbook" rel="section">
      <i class="menu-item-icon fa fa-fw fa-guest"></i> <br>留言</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
    
      
    
    <a href="https://github.com/isLouisHsu" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg>
    
      </a>
    



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/13/Elastic-Search/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Louis Hsu">
      <meta itemprop="description" content="技术博客？">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LOUIS' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Elastic Search
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-05-13 18:48:25" itemprop="dateCreated datePublished" datetime="2020-05-13T18:48:25+08:00">2020-05-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-05-18 09:49:01" itemprop="dateModified" datetime="2020-05-18T09:49:01+08:00">2020-05-18</time>
              
            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><blockquote>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" target="_blank" rel="noopener">Elasticsearch: 权威指南</a><br>注意ES6.x</p>
<ul>
<li><strong>移除<code>string</code>，新增<code>text</code>及<code>keyword</code>，并且<code>mappings</code>中<code>index</code>参数为布尔值</strong></li>
<li><strong>移除missing</strong></li>
</ul>
</blockquote>
<ul>
<li><a href="#%e7%9b%ae%e5%bd%95">目录</a></li>
<li><a href="#%e5%9f%ba%e7%a1%80%e5%85%a5%e9%97%a8">基础入门</a><ul>
<li><a href="#%e5%ae%89%e8%a3%85%e8%bf%90%e8%a1%8c">安装运行</a></li>
<li><a href="#%e7%89%b9%e6%80%a7">特性</a></li>
<li><a href="#%e4%ba%a4%e4%ba%92%e8%af%ad%e5%8f%a5">交互语句</a></li>
<li><a href="#%e6%95%b0%e6%8d%ae%e6%93%8d%e4%bd%9c">数据操作</a><ul>
<li><a href="#%e5%85%83%e6%95%b0%e6%8d%ae">元数据</a></li>
<li><a href="#%e6%a3%80%e6%9f%a5%e6%96%87%e6%a1%a3-head">检查文档: HEAD</a></li>
<li><a href="#%e7%b4%a2%e5%bc%95%e6%96%87%e6%a1%a3-put%e6%88%96post">索引文档: PUT或POST</a></li>
<li><a href="#%e6%96%b0%e5%bb%ba%e6%96%87%e6%a1%a3-put-urlcreat%e6%88%96post">新建文档: PUT /URL/_creat或POST</a></li>
<li><a href="#%e6%9b%b4%e6%96%b0%e6%96%87%e6%a1%a3-put">更新文档: PUT</a></li>
<li><a href="#%e9%83%a8%e5%88%86%e6%9b%b4%e6%96%b0-post-urlupdate">部分更新: POST /URL/_update</a></li>
<li><a href="#%e5%8f%96%e5%9b%9e%e6%96%87%e6%a1%a3-get">取回文档: GET</a></li>
<li><a href="#%e5%8f%96%e5%9b%9e%e5%a4%9a%e4%b8%aa%e6%96%87%e6%a1%a3-get-mget">取回多个文档: GET /_mget</a></li>
<li><a href="#%e5%88%a0%e9%99%a4%e6%96%87%e6%a1%a3-delete">删除文档: DELETE</a></li>
<li><a href="#%e6%89%b9%e9%87%8f%e6%93%8d%e4%bd%9c-post-bulk">批量操作: POST /_bulk</a></li>
</ul>
</li>
<li><a href="#%e6%90%9c%e7%b4%a2%e5%8f%af%e7%94%a8%e8%af%b7%e6%b1%82%e4%bd%93%e6%9f%a5%e8%af%a2%e6%9b%bf%e4%bb%a3">搜索(可用请求体查询替代)</a><ul>
<li><a href="#%e7%a9%ba%e6%90%9c%e7%b4%a2">空搜索</a></li>
<li><a href="#%e5%a4%9a%e7%b4%a2%e5%bc%95%e5%92%8c%e5%a4%9a%e7%b1%bb%e5%9e%8b">多索引和多类型</a></li>
<li><a href="#%e6%8c%87%e5%ae%9a%e6%9f%a5%e8%af%a2%e6%90%9c%e7%b4%a2">指定查询搜索</a></li>
<li><a href="#%e7%bb%93%e6%9e%9c%e5%88%86%e9%a1%b5">结果分页</a></li>
</ul>
</li>
<li><a href="#%e6%98%a0%e5%b0%84%e4%b8%8e%e5%88%86%e6%9e%90">映射与分析</a><ul>
<li><a href="#%e6%98%a0%e5%b0%84">映射</a><ul>
<li><a href="#%e7%ae%80%e5%8d%95%e5%9f%9f%e7%b1%bb%e5%9e%8b">简单域类型</a></li>
<li><a href="#%e6%9f%a5%e7%9c%8b%e6%98%a0%e5%b0%84-get-indexmapping">查看映射: GET /_index/_mapping</a></li>
<li><a href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%98%a0%e5%b0%84">自定义映射</a></li>
<li><a href="#%e6%9b%b4%e6%96%b0%e6%98%a0%e5%b0%84-put-index-%22mappings%22">更新映射: PUT /_index {“mappings”: {…} }</a></li>
<li><a href="#%e6%b5%8b%e8%af%95%e6%98%a0%e5%b0%84-get-indexanalyze">测试映射: GET /_index/_analyze</a></li>
</ul>
</li>
<li><a href="#%e5%88%86%e6%9e%90">分析</a></li>
</ul>
</li>
<li><a href="#%e8%af%b7%e6%b1%82%e4%bd%93%e6%9f%a5%e8%af%a2-get-urlsearch-%22query%22">请求体查询: GET /URL/_search {“query”: {…} }</a><ul>
<li><a href="#%e5%87%a0%e4%b8%aa%e9%87%8d%e8%a6%81%e7%9a%84%e6%9f%a5%e8%af%a2">几个重要的查询</a><ul>
<li><a href="#matchall">match_all</a></li>
<li><a href="#matchmultimatch">match/multi_match</a></li>
<li><a href="#termterms">term/terms</a></li>
<li><a href="#exists">exists</a></li>
<li><a href="#range">range</a></li>
</ul>
</li>
<li><a href="#%e7%bb%84%e5%90%88%e5%a4%9a%e4%b8%aa%e6%9f%a5%e8%af%a2">组合多个查询</a><ul>
<li><a href="#must">must</a></li>
<li><a href="#mustnot">must_not</a></li>
<li><a href="#should">should</a></li>
<li><a href="#filter">filter</a></li>
<li><a href="#bool">bool</a></li>
<li><a href="#constantscore">constant_score</a></li>
</ul>
</li>
<li><a href="#%e9%aa%8c%e8%af%81%e6%9f%a5%e8%af%a2-get-urlsearchvalidatequeryexplain">验证查询: GET /URL/_search/_validate/query?explain</a></li>
</ul>
</li>
<li><a href="#%e6%8e%92%e5%ba%8f%e4%b8%8e%e7%9b%b8%e5%85%b3%e6%80%a7">排序与相关性</a><ul>
<li><a href="#%e6%8e%92%e5%ba%8f-get-urlsearch--%22sort%22">排序: GET /URL/_search { “sort”: { … } }</a><ul>
<li><a href="#%e6%8c%89%e5%ad%97%e6%ae%b5%e5%80%bc%e6%8e%92%e5%ba%8f">按字段值排序</a></li>
<li><a href="#%e5%a4%9a%e7%ba%a7%e6%8e%92%e5%ba%8f">多级排序</a></li>
<li><a href="#%e5%a4%9a%e5%80%bc%e5%ad%97%e6%ae%b5%e6%8e%92%e5%ba%8f">多值字段排序</a></li>
</ul>
</li>
<li><a href="#%e7%9b%b8%e5%85%b3%e6%80%a7-score">相关性: _score</a></li>
</ul>
</li>
<li><a href="#%e7%b4%a2%e5%bc%95%e7%ae%a1%e7%90%86">索引管理</a><ul>
<li><a href="#%e5%88%9b%e5%bb%ba-put-index">创建: PUT /_index</a><ul>
<li><a href="#settings">settings</a><ul>
<li><a href="#numberofshardsnumberofreplicas">number_of_shards/number_of_replicas</a></li>
<li><a href="#analysis">analysis</a></li>
</ul>
</li>
<li><a href="#mappings">mappings</a></li>
</ul>
</li>
<li><a href="#%e5%88%a0%e9%99%a4-delete-index">删除: DELETE /_index</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%e6%b7%b1%e5%85%a5%e6%90%9c%e7%b4%a2">深入搜索</a><ul>
<li><a href="#%e7%bb%93%e6%9e%84%e5%8c%96%e6%90%9c%e7%b4%a2">结构化搜索</a><ul>
<li><a href="#%e7%b2%be%e7%a1%ae%e5%80%bc%e6%9f%a5%e6%89%be-term">精确值查找: term</a></li>
<li><a href="#%e7%bb%84%e5%90%88%e8%bf%87%e6%bb%a4%e5%99%a8-bool">组合过滤器: bool</a></li>
<li><a href="#%e7%b2%be%e7%a1%ae%e6%9f%a5%e6%89%be%e5%a4%9a%e4%b8%aa%e5%80%bc-terms">精确查找多个值: terms</a></li>
<li><a href="#%e8%8c%83%e5%9b%b4-range">范围: range</a></li>
<li><a href="#%e5%a4%84%e7%90%86%e7%a9%ba%e5%80%bc-exists">处理空值: exists</a></li>
</ul>
</li>
<li><a href="#%e5%85%a8%e6%96%87%e6%90%9c%e7%b4%a2">全文搜索</a><ul>
<li><a href="#%e5%8c%b9%e9%85%8d%e6%9f%a5%e8%af%a2-match">匹配查询: match</a></li>
<li><a href="#%e5%a4%9a%e8%af%8d%e6%9f%a5%e8%af%a2-match">多词查询: match</a></li>
<li><a href="#%e7%bb%84%e5%90%88%e6%9f%a5%e8%af%a2-bool">组合查询: bool</a></li>
<li><a href="#%e8%af%ad%e5%8f%a5%e6%9d%83%e9%87%8d-boost">语句权重: boost</a></li>
<li><a href="#%e6%8e%a7%e5%88%b6%e5%88%86%e6%9e%90-get-urlindexanalyze--%22field%22--%22text%22">控制分析: GET /URL/_index/_analyze { “field”: …, “text”: … }</a></li>
</ul>
</li>
<li><a href="#%e5%a4%9a%e5%ad%97%e6%ae%b5%e6%9f%a5%e8%af%a2">多字段查询</a><ul>
<li><a href="#%e5%a4%9a%e5%ad%97%e6%ae%b5%e6%9f%a5%e8%af%a2-multimatch">多字段查询: multi_match</a></li>
<li><a href="#%e6%9c%80%e4%bd%b3%e5%ad%97%e6%ae%b5bestfields-dismax">最佳字段(best_fields): dis_max</a></li>
<li><a href="#%e5%a4%9a%e6%95%b0%e5%ad%97%e6%ae%b5mostfields-fieldsubfield">多数字段(most_fields): field.subField</a></li>
<li><a href="#%e8%b7%a8%e5%ad%97%e6%ae%b5crossfields-filed1--filedn">跨字段(cross_fields): filed1, …, filedn</a></li>
<li><a href="#all%e5%ad%97%e6%ae%b5-copyto">_all字段: copy_to</a></li>
</ul>
</li>
<li><a href="#%e8%bf%91%e4%bc%bc%e5%8c%b9%e9%85%8d">近似匹配</a><ul>
<li><a href="#%e7%9f%ad%e8%af%ad%e5%8c%b9%e9%85%8d-matchphrase">短语匹配: match_phrase</a></li>
<li><a href="#%e7%bb%93%e6%9e%9c%e9%9b%86%e9%87%8d%e6%96%b0%e8%af%84%e5%88%86-rescore">结果集重新评分: rescore</a></li>
<li><a href="#%e7%9b%b8%e5%85%b3%e8%af%8d-shinglesngrams">相关词: shingles/Ngrams</a></li>
</ul>
</li>
<li><a href="#%e9%83%a8%e5%88%86%e5%8c%b9%e9%85%8d">部分匹配</a><ul>
<li><a href="#%e5%89%8d%e7%bc%80%e6%9f%a5%e8%af%a2-prefix">前缀查询: prefix</a></li>
<li><a href="#%e5%89%8d%e7%bc%80%e7%9f%ad%e8%af%ad%e5%8c%b9%e9%85%8d-matchphraseprefix">前缀短语匹配: match_phrase_prefix</a></li>
<li><a href="#%e9%80%9a%e9%85%8d%e7%ac%a6%e6%9f%a5%e8%af%a2-wildcard">通配符查询: wildcard</a></li>
<li><a href="#%e6%ad%a3%e5%88%99%e8%a1%a8%e8%be%be%e5%bc%8f%e6%9f%a5%e8%af%a2-regexp">正则表达式查询: regexp</a></li>
</ul>
</li>
<li><a href="#%e6%8e%a7%e5%88%b6%e7%9b%b8%e5%85%b3%e5%ba%a6">控制相关度</a></li>
</ul>
</li>
<li><a href="#%e8%81%9a%e5%90%88">聚合</a><ul>
<li><a href="#%e5%b0%9d%e8%af%95%e8%81%9a%e5%90%88">尝试聚合</a><ul>
<li><a href="#%e5%91%bd%e4%bb%a4%e6%a0%bc%e5%bc%8f-get-urlsearch--%22aggs%22--%22name%22--aggtype">命令格式: GET /URL/_search { “aggs”: { “NAME”: { AGG_TYPE: { … } } } }</a></li>
<li><a href="#%e7%ae%80%e5%8d%95%e4%be%8b%e5%ad%90-terms-avg-max-min">简单例子: terms, avg, max, min</a></li>
</ul>
</li>
<li><a href="#%e9%99%90%e5%ae%9a%e8%81%9a%e5%90%88%e8%8c%83%e5%9b%b4-query-global">限定聚合范围: query, global</a></li>
<li><a href="#%e7%9b%b4%e6%96%b9%e5%9b%be%e7%bb%9f%e8%ae%a1-histogram">直方图统计: histogram</a></li>
<li><a href="#%e7%bb%9f%e8%ae%a1%e9%87%8f%e8%ae%a1%e7%ae%97-extendedstats">统计量计算: extended_stats</a></li>
<li><a href="#%e6%8c%89%e6%97%b6%e9%97%b4%e7%bb%9f%e8%ae%a1-datehistogram">按时间统计: date_histogram</a></li>
<li><a href="#%e8%bf%87%e6%bb%a4%e5%92%8c%e8%81%9a%e5%90%88">过滤和聚合</a><ul>
<li><a href="#%e6%9f%a5%e8%af%a2%e8%bf%87%e6%bb%a4-%22query%22---%22filter%22">查询过滤: “query”: { …, “filter”, … }</a></li>
<li><a href="#%e8%81%9a%e5%90%88%e8%bf%87%e6%bb%a4-%22aggs%22---%22filter%22">聚合过滤: “aggs”: { …, “filter”, … }</a></li>
<li><a href="#%e5%90%8e%e8%bf%87%e6%bb%a4%e5%99%a8-postfilter">后过滤器: post_filter</a></li>
</ul>
</li>
<li><a href="#%e5%a4%9a%e6%a1%b6%e6%8e%92%e5%ba%8f-order">多桶排序: order</a><ul>
<li><a href="#%e5%86%85%e7%bd%ae%e6%8e%92%e5%ba%8f-count-term-key">内置排序: _count, _term, _key</a></li>
<li><a href="#%e6%8c%89%e5%ba%a6%e9%87%8f%e6%8e%92%e5%ba%8f%e8%87%aa%e5%ae%9a%e4%b9%89%e5%b5%8c%e5%a5%97%e5%ba%a6%e9%87%8f">按度量排序:自定义嵌套度量</a></li>
<li><a href="#%e6%b7%b1%e5%ba%a6%e5%ba%a6%e9%87%8f%e6%8e%92%e5%ba%8f%e8%87%aa%e5%ae%9a%e4%b9%89%e5%b5%8c%e5%a5%97%e6%9b%b4%e6%b7%b1%e7%9a%84%e5%ba%a6%e9%87%8f">“深度”度量排序:自定义嵌套更深的度量</a></li>
</ul>
</li>
<li><a href="#%e8%bf%91%e4%bc%bc%e8%81%9a%e5%90%88">近似聚合</a><ul>
<li><a href="#%e7%bb%9f%e8%ae%a1%e5%8e%bb%e9%87%8d%e5%90%8e%e7%9a%84%e6%95%b0%e7%9b%ae-cardinality">统计去重后的数目: cardinality</a><ul>
<li><a href="#%e8%ae%be%e7%bd%ae%e7%b2%be%e5%ba%a6-precisionthreshold">设置精度: precision_threshold</a></li>
<li><a href="#%e4%bc%98%e5%8c%96%e9%80%9f%e5%ba%a6-hash">优化速度: hash</a></li>
</ul>
</li>
<li><a href="#%e7%99%be%e5%88%86%e4%bd%8d%e6%95%b0%e5%ba%a6%e9%87%8f-percentiles">百分位数度量: percentiles</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#elasticsearch-py">elasticsearch-py</a></li>
</ul>
<h1 id="基础入门"><a href="#基础入门" class="headerlink" title="基础入门"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/getting-started.html" target="_blank" rel="noopener">基础入门</a></h1><ul>
<li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distributed-cluster.html" target="_blank" rel="noopener">Elasticsearch: 权威指南 » 基础入门 » 集群内的原理</a></li>
</ul>
<h2 id="安装运行"><a href="#安装运行" class="headerlink" title="安装运行"></a>安装运行</h2><blockquote>
<p>注意JDK8仅支持<a href="https://www.elastic.co/cn/downloads/past-releases/elasticsearch-6-6-0" target="_blank" rel="noopener">Elasticsearch 6.x</a>和<a href="https://www.elastic.co/cn/downloads/past-releases/kibana-6-6-0" target="_blank" rel="noopener">Kibana 6.x</a></p>
</blockquote>
<ul>
<li><p>下载并解压</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.6.0.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxvf elasticsearch-6.6.0.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://artifacts.elastic.co/downloads/kibana/kibana-6.6.0-linux-x86_64.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxvf kibana-6.6.0-linux-x86_64.tar.gz</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件<code>elasticsearch-6.6.0/config/elasticsearch.yml</code></p>
<p>  主要修改的几条配置如下</p>
  <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="string">cluster.name:</span> <span class="string">louishsu-application</span></span><br><span class="line"><span class="comment"># ----------------------------------- Paths ------------------------------------</span></span><br><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="string">path.data:</span> <span class="string">/home/louishsu/Downloads/elasticsearch-6.6.0/tmp/data</span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="string">path.logs:</span> <span class="string">/home/louishsu/Downloads/elasticsearch-6.6.0/tmp/logs</span></span><br></pre></td></tr></table></figure>
<p>  补齐文件夹</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir tmp</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir tmp/data tmp/logs</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加环境变量：将<code>elasticsearch-6.6.0/bin/</code>和<code>kibana-6.6.0-linux-x86_64/bin/</code>目录添加到环境变量<code>${PATH}</code>中</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> &gt;&gt;&gt; elasticsearch &gt;&gt;&gt;</span></span><br><span class="line">export ELASTICSEARCH_HOME=/home/louishsu/Downloads/elasticsearch-6.6.0</span><br><span class="line">export PATH=$PATH:$ELASTICSEARCH_HOME/bin</span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;&lt;&lt; elasticsearch &lt;&lt;&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> &gt;&gt;&gt; kibana &gt;&gt;&gt;</span></span><br><span class="line">export KIBANA_HOME=/home/louishsu/Downloads/kibana-6.6.0-linux-x86_64</span><br><span class="line">export PATH=$PATH:$KIBANA_HOME/bin</span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;&lt;&lt; kibana &lt;&lt;&lt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行ElasticSearch</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> elasticsearch</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>  对<code>http://localhost:9200/?pretty</code>发送请求，可以得到如下输出</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl <span class="string">'http://localhost:9200/?pretty'</span></span></span><br><span class="line">&#123;</span><br><span class="line">    "name" : "KFnpkyD",</span><br><span class="line">    "cluster_name" : "louishsu-application",</span><br><span class="line">    "cluster_uuid" : "Jc3kJRbKSWeqUvNepFWogQ",</span><br><span class="line">    "version" : &#123;</span><br><span class="line">        "number" : "6.6.0",</span><br><span class="line">        "build_flavor" : "default",</span><br><span class="line">        "build_type" : "tar",</span><br><span class="line">        "build_hash" : "a9861f4",</span><br><span class="line">        "build_date" : "2019-01-24T11:27:09.439740Z",</span><br><span class="line">        "build_snapshot" : false,</span><br><span class="line">        "lucene_version" : "7.6.0",</span><br><span class="line">        "minimum_wire_compatibility_version" : "5.6.0",</span><br><span class="line">        "minimum_index_compatibility_version" : "5.0.0"</span><br><span class="line">    &#125;,</span><br><span class="line">    "tagline" : "You Know, for Search"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行Kibana<br>  运行kibana，并通过<code>http://localhost:5601</code>访问</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kibana</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>ES是<strong>面向文档</strong>的，存储整个对象或<strong>文档</strong>，通过<strong>索引</strong>每个文档的内容使其可以被检索。同其他NoSQL一样，使用JSON作为文档序列化格式，例如一个<code>user</code>对象可以表示为<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"email"</span>:      <span class="string">"john@smith.com"</span>,</span><br><span class="line">    <span class="attr">"first_name"</span>: <span class="string">"John"</span>,</span><br><span class="line">    <span class="attr">"last_name"</span>:  <span class="string">"Smith"</span>,</span><br><span class="line">    <span class="attr">"info"</span>: &#123;</span><br><span class="line">        <span class="attr">"bio"</span>:         <span class="string">"Eco-warrior and defender of the weak"</span>,</span><br><span class="line">        <span class="attr">"age"</span>:         <span class="number">25</span>,</span><br><span class="line">        <span class="attr">"interests"</span>: [ <span class="string">"dolphins"</span>, <span class="string">"whales"</span> ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"join_date"</span>: <span class="string">"2014/05/01"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一个 Elasticsearch 集群可以包含多个<strong>索引</strong>(指向一个或者多个物理<strong>分片</strong>的逻辑命名空间) ，相应的每个索引可以包含多个<strong>类型</strong>。 这些不同的类型存储着多个<strong>文档</strong>，每个文档又有多个<strong>属性</strong>，文档路径表示为<code>/_index/_type/_id</code>。</p>
<h2 id="交互语句"><a href="#交互语句" class="headerlink" title="交互语句"></a>交互语句</h2><p>Elasticsearch请求和HTTP请求类似，由以下格式组成<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X &lt;VERB&gt; '&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;' -d '&lt;BODY&gt;'</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>若希望得到<code>head</code>信息，添加<code>-i</code>，即<code>curl -i -X&lt;...</code></li>
<li><p>表示为缩写格式(Kibana, Sense等控制台中使用)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">   &lt;VERB&gt; /&lt;PATH&gt;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">   &lt;BODY&gt;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在kibana的dev tool中可将缩写格式快速转换为<code>curl</code>。</p>
</li>
</ul>
</blockquote>
<p>例如获取集群中文档的数目<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://localhost:9200/_count?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "match_all": &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure></p>
<p>对应缩写格式为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_count</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "match_all": &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中各部件说明如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>部件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VERB</code></td>
<td>HTTP方法或谓词，<code>GET, HEAD, PUT, POST, DELETE</code></td>
</tr>
<tr>
<td><code>PROTOCOL</code></td>
<td><code>http</code>或<code>https</code>(ES前有<code>https</code>代理的情况下)</td>
</tr>
<tr>
<td><code>HOST</code></td>
<td>ES集群中节点的主机名，本地主机用<code>localhost</code>表示</td>
</tr>
<tr>
<td><code>PORT</code></td>
<td>主机运行ES服务的端口号，默认<code>9200</code></td>
</tr>
<tr>
<td><code>PATH</code></td>
<td>API的终端路径，<code>/_index/_type/_id</code>，，及<code>_count, _search</code>等</td>
</tr>
<tr>
<td><code>QUERY_STRING</code></td>
<td>查询字符串，如<code>?pretty</code></td>
</tr>
<tr>
<td><code>BODY</code></td>
<td>JSON格式的请求体(如果需要)</td>
</tr>
</tbody>
</table>
</div>
<h2 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h2><h3 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h3><p>文档元数据包括</p>
<ul>
<li>索引(<code>_index</code>)：因共同的特性被分组到一起的文档集合；</li>
<li>类别(<code>_type</code>)：共享一种相同的（或非常相似）模式的文档集合，定义“子分区”；</li>
<li>标识(<code>_id</code>)：文档的唯一标识，字符串。</li>
</ul>
<h3 id="检查文档-HEAD"><a href="#检查文档-HEAD" class="headerlink" title="检查文档: HEAD"></a>检查文档: HEAD</h3><p>仅获得HTTP请求报头<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD /website/blog/123</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">200 OK</span><br></pre></td></tr></table></figure>
<h3 id="索引文档-PUT或POST"><a href="#索引文档-PUT或POST" class="headerlink" title="索引文档: PUT或POST"></a>索引文档: PUT或POST</h3><p>索引文档是指将文档<strong>存储，并可被索引</strong>，其基本命令格式为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /&#123;index&#125;/&#123;type&#125;/&#123;id&#125;</span><br><span class="line">&#123;</span><br><span class="line">  "field": "value",</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>新建索引<code>website</code>，类别<code>bolg</code>，文档编号<code>123</code>，用命令<code>PUT</code></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/123</span><br><span class="line">&#123;</span><br><span class="line">    "title": "My first blog entry",</span><br><span class="line">    "text":  "Just trying this out...",</span><br><span class="line">    "date":  "2014/01/01"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "_index":    "website",</span><br><span class="line">    "_type":     "blog",</span><br><span class="line">    "_id":       "123",</span><br><span class="line">    "_version":  1,</span><br><span class="line">    "created":   true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不指定文档编号，也可自动生成<code>_id</code>，用命令<code>POST</code></p>
<blockquote>
<p>自动生成的 ID 是 URL-safe、 基于 Base64 编码且长度为20个字符的 GUID 字符串。 这些 GUID 字符串由可修改的 FlakeID 模式生成，这种模式允许多个节点并行生成唯一 ID ，且互相之间的冲突概率几乎为零。</p>
</blockquote>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123;</span><br><span class="line">    "title": "My second blog entry",</span><br><span class="line">    "text":  "Still trying this out...",</span><br><span class="line">    "date":  "2014/01/01"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "_index":    "website",</span><br><span class="line">    "_type":     "blog",</span><br><span class="line">    "_id":       "AVFgSgVHUP18jI2wRx0w",</span><br><span class="line">    "_version":  1,</span><br><span class="line">    "created":   true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="新建文档-PUT-URL-creat或POST"><a href="#新建文档-PUT-URL-creat或POST" class="headerlink" title="新建文档: PUT /URL/_creat或POST"></a>新建文档: PUT /URL/_creat或POST</h3><p>若希望创建全新文档而不是覆盖原有文档</p>
<ul>
<li><p><code>PUT</code>命令中添加<code>_creat</code>，可指定<code>_id</code></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/123/_create</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PUT /website/blog/123?op_type=create</span></span><br><span class="line">&#123;</span><br><span class="line">    "title": "My first blog entry",</span><br><span class="line">    "text":  "Just trying this out...",</span><br><span class="line">    "date":  "2014/01/01"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  若文档<code>_index/_type/_id</code>已存在，则会返回<code>409</code>错误</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "error": &#123;</span><br><span class="line">        "root_cause": [</span><br><span class="line">        &#123;</span><br><span class="line">            "type": "version_conflict_engine_exception",</span><br><span class="line">            "reason": "[blog][123]: version conflict, document already exists (current version [1])",</span><br><span class="line">            "index_uuid": "TEPTZxdTRi6aAXE-lRvvFQ",</span><br><span class="line">            "shard": "0",</span><br><span class="line">            "index": "website"</span><br><span class="line">        &#125;</span><br><span class="line">        ],</span><br><span class="line">        "type": "version_conflict_engine_exception",</span><br><span class="line">        "reason": "[blog][123]: version conflict, document already exists (current version [1])",</span><br><span class="line">        "index_uuid": "TEPTZxdTRi6aAXE-lRvvFQ",</span><br><span class="line">        "shard": "0",</span><br><span class="line">        "index": "website"</span><br><span class="line">    &#125;,</span><br><span class="line">    "status": 409</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>POST</code>命令生成唯一<code>_id</code></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123;</span><br><span class="line">    "title": "My third blog entry",</span><br><span class="line">    "text":  "Still trying this out...",</span><br><span class="line">    "date":  "2014/01/01"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "_index" : "website",</span><br><span class="line">    "_type" : "blog",</span><br><span class="line">    "_id" : "G62WC3IBb2a50-3pYPp3",</span><br><span class="line">    "_version" : 1,</span><br><span class="line">    "result" : "created",</span><br><span class="line">    "_shards" : &#123;</span><br><span class="line">        "total" : 2,</span><br><span class="line">        "successful" : 1,</span><br><span class="line">        "failed" : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    "_seq_no" : 0,</span><br><span class="line">    "_primary_term" : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="更新文档-PUT"><a href="#更新文档-PUT" class="headerlink" title="更新文档: PUT"></a>更新文档: PUT</h3><p>在ES中文档是<strong>不可变</strong>的，实际上更新现有文档是通过<strong>重建索引</strong>进行替换实现的<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/123</span><br><span class="line">&#123;</span><br><span class="line">  "title": "My first blog entry",</span><br><span class="line">  "text":  "I am starting to get the hang of this...",</span><br><span class="line">  "date":  "2014/01/02"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "_index" : "website",</span><br><span class="line">  "_type" : "blog",</span><br><span class="line">  "_id" : "123",</span><br><span class="line">  "_version" : 2,</span><br><span class="line">  "result" : "updated",</span><br><span class="line">  "_shards" : &#123;</span><br><span class="line">    "total" : 2,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "_seq_no" : 4,</span><br><span class="line">  "_primary_term" : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="部分更新-POST-URL-update"><a href="#部分更新-POST-URL-update" class="headerlink" title="部分更新: POST /URL/_update"></a>部分更新: POST /URL/_update</h3><p>在<code>POST</code>指令中添加<code>_update</code>选项，可接收文档的一部分内容，并进行更新<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/3/_update</span><br><span class="line">&#123;</span><br><span class="line">   "doc" : &#123;</span><br><span class="line">    "date":  "2020/01/02"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "_index" : "website",</span><br><span class="line">  "_type" : "blog",</span><br><span class="line">  "_id" : "3",</span><br><span class="line">  "_version" : 2,</span><br><span class="line">  "result" : "updated",</span><br><span class="line">  "_shards" : &#123;</span><br><span class="line">    "total" : 2,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "_seq_no" : 1,</span><br><span class="line">  "_primary_term" : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="取回文档-GET"><a href="#取回文档-GET" class="headerlink" title="取回文档: GET"></a>取回文档: GET</h3><ul>
<li><p>用<code>GET</code>指令取回文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/123?pretty</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> HTTP/1.1 200 OK</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> content-type: application/json; charset=UTF-8</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> content-length: 264</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "_index" :   "website",</span><br><span class="line">    "_type" :    "blog",</span><br><span class="line">    "_id" :      "123",</span><br><span class="line">    "_version" : 1,</span><br><span class="line">    "found" :    true,</span><br><span class="line">    "_source" :  &#123;</span><br><span class="line">        "title": "My first blog entry",</span><br><span class="line">        "text":  "Just trying this out...",</span><br><span class="line">        "date":  "2014/01/01"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>只返回<code>_source</code>字段</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/123/_source</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "title": "My first blog entry",</span><br><span class="line">    "text":  "Just trying this out...",</span><br><span class="line">    "date":  "2014/01/01"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过<code>_source</code>指定文档的部分信息，例如只返回<code>title</code>和<code>text</code>，忽略<code>date</code></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/123?_source=title,text</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "_index" : "website",</span><br><span class="line">    "_type" : "blog",</span><br><span class="line">    "_id" : "123",</span><br><span class="line">    "_version" : 1,</span><br><span class="line">    "_seq_no" : 0,</span><br><span class="line">    "_primary_term" : 1,</span><br><span class="line">    "found" : true,</span><br><span class="line">    "_source" : &#123;</span><br><span class="line">        "text" : "Just trying this out...",</span><br><span class="line">        "title" : "My first blog entry"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="取回多个文档-GET-mget"><a href="#取回多个文档-GET-mget" class="headerlink" title="取回多个文档: GET /_mget"></a>取回多个文档: GET /_mget</h3><p>在<code>GET</code>命令中添加<code>_mget</code>选项，可取回多个文档，需接收<code>docs</code>参数指定文档元数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   "docs" : [</span><br><span class="line">      &#123;</span><br><span class="line">         "_index" : "website",</span><br><span class="line">         "_type" :  "blog",</span><br><span class="line">         "_id" :    3</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         "_index" : "website",</span><br><span class="line">         "_type" :  "pageviews",</span><br><span class="line">         "_id" :    1,</span><br><span class="line">         "_source": "views"</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于同一索引或同一类型中的文档，可指定<code>_index/_type/</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/_mget</span><br><span class="line">&#123;</span><br><span class="line">   "docs" : [</span><br><span class="line">      &#123; "_id" : 3 &#125;,</span><br><span class="line">      &#123; "_type" : "pageviews", "_id" :   1 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或者用<code>ids</code>参数指定<code>_id</code>列表<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/_mget</span><br><span class="line">&#123;</span><br><span class="line">   "ids" : ["3", "1"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>响应结果相同，均为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "docs" : [</span><br><span class="line">    &#123;</span><br><span class="line">      "_index" : "website",</span><br><span class="line">      "_type" : "blog",</span><br><span class="line">      "_id" : "3",</span><br><span class="line">      "_version" : 2,</span><br><span class="line">      "_seq_no" : 1,</span><br><span class="line">      "_primary_term" : 2,</span><br><span class="line">      "found" : true,</span><br><span class="line">      "_source" : &#123;</span><br><span class="line">        "title" : "My first blog entry",</span><br><span class="line">        "text" : "I am starting to get the hang of this...",</span><br><span class="line">        "date" : "2020/01/02"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "_index" : "website",</span><br><span class="line">      "_type" : "pageviews",</span><br><span class="line">      "_id" : "1",</span><br><span class="line">      "found" : false</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="删除文档-DELETE"><a href="#删除文档-DELETE" class="headerlink" title="删除文档: DELETE"></a>删除文档: DELETE</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /website/blog/123</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "_index" : "website",</span><br><span class="line">  "_type" : "blog",</span><br><span class="line">  "_id" : "123",</span><br><span class="line">  "_version" : 2,</span><br><span class="line">  "result" : "deleted",</span><br><span class="line">  "_shards" : &#123;</span><br><span class="line">    "total" : 2,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "_seq_no" : 1,</span><br><span class="line">  "_primary_term" : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若不存在，则返回如下，注意<code>_version</code>仍旧增加<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "_index" : "website",</span><br><span class="line">  "_type" : "blog",</span><br><span class="line">  "_id" : "123",</span><br><span class="line">  "_version" : 3,</span><br><span class="line">  "result" : "not_found",</span><br><span class="line">  "_shards" : &#123;</span><br><span class="line">    "total" : 2,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "_seq_no" : 2,</span><br><span class="line">  "_primary_term" : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="批量操作-POST-bulk"><a href="#批量操作-POST-bulk" class="headerlink" title="批量操作: POST /_bulk"></a>批量操作: POST /_bulk</h3><p>在<code>POST</code>命令中添加<code>_bulk</code>选项，进行批量处理，每个子请求都是独立执行，因此某个子请求的失败不会对其他子请求的成功与否造成影响，基本格式为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; action: &#123; metadata &#125;&#125;</span><br><span class="line">&#123; request body        &#125;</span><br><span class="line">&#123; action: &#123; metadata &#125;&#125;</span><br><span class="line">&#123; request body        &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><code>action</code></p>
<p>  | <code>action</code> | 说明 |<br>  | —- | —- |<br>  | <code>create</code> | 如果文档不存在，那么就创建它 |<br>  | <code>index</code> | 创建一个新文档或者替换一个现有的文档 |<br>  | <code>update</code> | 部分更新一个文档 |<br>  | <code>delete</code> | 删除一个文档 |</p>
</li>
<li><p><code>metadata</code>指定<code>_index, _type, _id</code></p>
</li>
<li><code>request body</code> 行由文档的 <code>_source</code> 本身组成—​文档包含的字段和值。它是 <code>index</code> 和 <code>create</code> 操作所必需的；它也是 <code>update</code> 操作所必需的，并且应该包含你传递给 <code>update</code> API 的相同请求体： <code>doc</code> 、 <code>upsert</code> 、 <code>script</code> 等等。 删除操作不需要 <code>request body</code> 行。</li>
</ul>
<p>例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; "delete": &#123; "_index": "website", "_type": "blog", "_id": "123" &#125;&#125; </span><br><span class="line">&#123; "create": &#123; "_index": "website", "_type": "blog", "_id": "123" &#125;&#125;</span><br><span class="line">&#123; "title":    "My first blog post" &#125;</span><br><span class="line">&#123; "index":  &#123; "_index": "website", "_type": "blog" &#125;&#125;</span><br><span class="line">&#123; "title":    "My second blog post" &#125;</span><br><span class="line">&#123; "update": &#123; "_index": "website", "_type": "blog", "_id": "123", "_retry_on_conflict" : 3&#125; &#125;</span><br><span class="line">&#123; "doc" : &#123;"title" : "My updated blog post"&#125; &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "took" : 203,</span><br><span class="line">  "errors" : false,</span><br><span class="line">  "items" : [</span><br><span class="line">    &#123;</span><br><span class="line">      "delete" : &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "123",</span><br><span class="line">        "_version" : 3,</span><br><span class="line">        "result" : "deleted",</span><br><span class="line">        "_shards" : &#123;</span><br><span class="line">          "total" : 2,</span><br><span class="line">          "successful" : 1,</span><br><span class="line">          "failed" : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        "_seq_no" : 5,</span><br><span class="line">        "_primary_term" : 2,</span><br><span class="line">        "status" : 200</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "create" : &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "123",</span><br><span class="line">        "_version" : 4,</span><br><span class="line">        "result" : "created",</span><br><span class="line">        "_shards" : &#123;</span><br><span class="line">          "total" : 2,</span><br><span class="line">          "successful" : 1,</span><br><span class="line">          "failed" : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        "_seq_no" : 6,</span><br><span class="line">        "_primary_term" : 2,</span><br><span class="line">        "status" : 201</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "index" : &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "HK23C3IBb2a50-3pQPpQ",</span><br><span class="line">        "_version" : 1,</span><br><span class="line">        "result" : "created",</span><br><span class="line">        "_shards" : &#123;</span><br><span class="line">          "total" : 2,</span><br><span class="line">          "successful" : 1,</span><br><span class="line">          "failed" : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        "_seq_no" : 2,</span><br><span class="line">        "_primary_term" : 2,</span><br><span class="line">        "status" : 201</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "update" : &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "123",</span><br><span class="line">        "_version" : 5,</span><br><span class="line">        "result" : "updated",</span><br><span class="line">        "_shards" : &#123;</span><br><span class="line">          "total" : 2,</span><br><span class="line">          "successful" : 1,</span><br><span class="line">          "failed" : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        "_seq_no" : 7,</span><br><span class="line">        "_primary_term" : 2,</span><br><span class="line">        "status" : 200</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="搜索-可用请求体查询替代"><a href="#搜索-可用请求体查询替代" class="headerlink" title="搜索(可用请求体查询替代)"></a>搜索(可用<a href="#%e8%af%b7%e6%b1%82%e4%bd%93%e6%9f%a5%e8%af%a2">请求体查询</a>替代)</h2><h3 id="空搜索"><a href="#空搜索" class="headerlink" title="空搜索"></a>空搜索</h3><p>不指定任何查询条件的搜索<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "took" : 27,                  # 搜索还费时间(毫秒)</span><br><span class="line">  "timed_out" : false,          # 是否超时</span><br><span class="line">  "_shards" : &#123;                 # 主分片信息</span><br><span class="line">    "total" : 6,                # 参与分片总数</span><br><span class="line">    "successful" : 6,           # 成功个数</span><br><span class="line">    "skipped" : 0,              # 跳过个数</span><br><span class="line">    "failed" : 0                # 失败个数</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : 9,                # 匹配到的文档总数</span><br><span class="line">    "max_score" : 1.0,</span><br><span class="line">    "hits" : [                  # 文档列表</span><br><span class="line">      ...</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "123",</span><br><span class="line">        "_score" : 1.0,         # 文档与查询的匹配度</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My updated blog post"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "G62WC3IBb2a50-3pYPp3",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My third blog entry",</span><br><span class="line">          "text" : "Still trying this out...",</span><br><span class="line">          "date" : "2014/01/01"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多索引和多类型"><a href="#多索引和多类型" class="headerlink" title="多索引和多类型"></a>多索引和多类型</h3><p>假如当前存在索引<code>gb, us</code>，类型为<code>user, tweet</code>，希望查找文档，可进行多索引/多类型查询</p>
<ul>
<li><p>搜索所有索引和类型</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search                # 在所有索引中搜索所有类型</span><br></pre></td></tr></table></figure>
</li>
<li><p>搜索指定索引</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /gb/_search             # 在索引`gb`中搜索</span><br><span class="line">GET /gb,us/_search          # 在索引`gb, us`中搜索</span><br><span class="line">GET /g*,u*/_search          # 支持字符匹配</span><br></pre></td></tr></table></figure>
</li>
<li><p>搜索指定类型</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /_all/user/_search      # 在所有索引中搜索`user`类型，注意`_all`只能用于代表全部索引</span><br><span class="line">GET /gb/user/_search        # 在索引`gb`中搜索`user`类型</span><br><span class="line">GET /gb/user,tweet/_search  # 在索引`gb`中搜索`user, tweet`类型</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="指定查询搜索"><a href="#指定查询搜索" class="headerlink" title="指定查询搜索"></a>指定查询搜索</h3><ul>
<li><p>在<code>tweet</code>类型中查询字段<code>&quot;tweet&quot;</code>包含<code>&quot;elasticsearhc&quot;</code>单词的所有文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_all/tweet/_search?q=tweet:elasticsearch</span><br></pre></td></tr></table></figure>
</li>
<li><p>在所有结果中查询字段<code>&quot;name&quot;</code>包含<code>&quot;john&quot;</code>且<code>&quot;tweet&quot;</code>字段中包含<code>&quot;mary&quot;</code>的文档，</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+name:john +tweet:mary</span><br></pre></td></tr></table></figure>
<p>  其URL编码如下</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=%2Bname%3Ajohn+%2Btweet%3Amary</span><br></pre></td></tr></table></figure>
<ul>
<li><code>%2B</code>为<code>+</code>，<code>%3A</code>为<code>:</code>，故上句中实际为</li>
<li><code>+</code>前缀表示必须与查询条件匹配，<code>-</code>表示不一定与查询条件匹配。</li>
</ul>
</li>
<li><p>在所有结果中查询<code>&quot;name&quot;</code>包含<code>&quot;john&quot;, &quot;mary&quot;</code>，<code>&quot;date&quot;</code>字段值大于<code>&quot;2014-09-10&quot;</code>，<code>&quot;all&quot;</code>字段包含<code>&quot;aggregations&quot;</code>或者<code>&quot;geo&quot;</code></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+name:(john mary) +date:&gt;2014-09-10 +(aggregations geo)</span><br></pre></td></tr></table></figure>
<p>  相应编码为</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?q=%2Bname%3A(john+mary)+%2Bdate%3A%3E2014-09-10+%2B(aggregations+geo)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="结果分页"><a href="#结果分页" class="headerlink" title="结果分页"></a>结果分页</h3><p>用<code>size</code>和<code>from</code>参数指定分页尺寸</p>
<ul>
<li><code>size</code>: 每页显示结果条数，默认为10</li>
<li><code>from</code>: 跳过的初始结果数目</li>
</ul>
<p>例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?size=2             # 每页显示2条结果</span><br><span class="line">GET /_search?size=2&amp;from=1      # 每页显示2条结果，从第2条开始显示</span><br></pre></td></tr></table></figure></p>
<p>相应分别为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "max_score" : 1.0,</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "123",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My updated blog post"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "G62WC3IBb2a50-3pYPp3",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My third blog entry",</span><br><span class="line">          "text" : "Still trying this out...",</span><br><span class="line">          "date" : "2014/01/01"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "max_score" : 1.0,</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "G62WC3IBb2a50-3pYPp3",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My third blog entry",</span><br><span class="line">          "text" : "Still trying this out...",</span><br><span class="line">          "date" : "2014/01/01"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "l5WYCHIBrXn2VHz0FgRn",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My second blog entry",</span><br><span class="line">          "text" : "Still trying this out...",</span><br><span class="line">          "date" : "2014/01/01"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="映射与分析"><a href="#映射与分析" class="headerlink" title="映射与分析"></a>映射与分析</h2><h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p><strong>映射</strong>(mapping)定义了类型中的域、每个域的数据类型和ES如何处理这些域，也用于配置与类型有关的元数据。</p>
<h4 id="简单域类型"><a href="#简单域类型" class="headerlink" title="简单域类型"></a>简单域类型</h4><p>ES支持如下简单域类型</p>
<ul>
<li>字符串: <code>text</code>, <code>keyword</code></li>
<li>整数 : <code>byte</code>, <code>short</code>, <code>integer</code>, <code>long</code></li>
<li>浮点数: <code>float</code>, <code>double</code></li>
<li>布尔型: <code>boolean</code></li>
<li>日期: <code>date</code></li>
</ul>
<h4 id="查看映射-GET-index-mapping"><a href="#查看映射-GET-index-mapping" class="headerlink" title="查看映射: GET /_index/_mapping"></a>查看映射: GET /_index/_mapping</h4><p>查看ES对索引<code>website</code>默认生成的<code>mapping</code>，<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_mapping</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "website" : &#123;                 #_index</span><br><span class="line">    "mappings" : &#123;              # 注意mapping是_index的属性</span><br><span class="line">      "blog" : &#123;                # _type</span><br><span class="line">        "properties" : &#123;        # _type的各属性定义</span><br><span class="line">          "date" : &#123;</span><br><span class="line">            "type" : "date",</span><br><span class="line">            "format" : "yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis"</span><br><span class="line">          &#125;,</span><br><span class="line">          "text" : &#123;</span><br><span class="line">            "type" : "text",</span><br><span class="line">            "fields" : &#123;</span><br><span class="line">              "keyword" : &#123;</span><br><span class="line">                "type" : "keyword",</span><br><span class="line">                "ignore_above" : 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          "title" : &#123;</span><br><span class="line">            "type" : "text",</span><br><span class="line">            "fields" : &#123;</span><br><span class="line">              "keyword" : &#123;</span><br><span class="line">                "type" : "keyword",</span><br><span class="line">                "ignore_above" : 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义映射"><a href="#自定义映射" class="headerlink" title="自定义映射"></a>自定义映射</h4><p>若需要为域自定义映射，允许执行下面操作</p>
<ul>
<li><p>全文字符串域和精确字符串域的区别: <code>index</code><br>  可选以下3种</p>
<ul>
<li>analyzed: 进行分析后，全文索引该域；</li>
<li>not_analyzed: 精确索引，能够被搜索但不进行分析；</li>
<li><code>no</code>: 不对该域进行索引，不会被搜索到。<blockquote>
<p>分析是指进行大小字母匹配、同义词替换等操作。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>使用特定语言分析器: <code>analyzer</code><br>  默认使用<code>standard</code>分析器，其余可选内置分析器有<code>whitespace</code>、<code>simple</code>和<code>english</code>等</p>
</li>
<li><p>优化域以适应部分匹配</p>
</li>
<li>指定自定义数据格式</li>
<li>…</li>
</ul>
<h4 id="更新映射-PUT-index-“mappings”-…"><a href="#更新映射-PUT-index-“mappings”-…" class="headerlink" title="更新映射: PUT /_index {“mappings”: {…} }"></a>更新映射: PUT /_index {“mappings”: {…} }</h4><p>创建索引时，指定类型的映射；用<code>/mapping</code>为新类型增加映射，或为存在类型更新映射，但是不能修存在的类型映射，否则会破坏索引。<strong>同一索引内的所有类型(字段不冲突)共享相同的映射</strong>。</p>
<p>注意每个域可包含多个值，构成数组，但数组元素必须是相同类型的，如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"tag": ["search", "nosql"]</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>新建索引<code>/gb</code>并添加映射</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /gb </span><br><span class="line">&#123;</span><br><span class="line">    "mappings": &#123;                               # gb索引内所有类型的映射</span><br><span class="line">        "tweet" : &#123;                             # 自定义映射名</span><br><span class="line">            "properties" : &#123;</span><br><span class="line">                "tweet" : &#123;</span><br><span class="line">                    "type" :    "text",</span><br><span class="line">                    "analyzer": "english"       # 指定分析器</span><br><span class="line">                &#125;,</span><br><span class="line">                "date" : &#123;</span><br><span class="line">                    "type" :   "date"</span><br><span class="line">                &#125;,</span><br><span class="line">                "name" : &#123;</span><br><span class="line">                    "type" :   "text",</span><br><span class="line">                &#125;,</span><br><span class="line">                "user_id" : &#123;</span><br><span class="line">                    "type" :   "long"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>为<code>tweet</code>新增文本域<code>tag</code>，已存在的域不能修改，故不必指定</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /gb/_mapping/tweet</span><br><span class="line">&#123;</span><br><span class="line">    "properties" : &#123;</span><br><span class="line">        "tag" : &#123;</span><br><span class="line">        "type" :    "keyword"                   # 精确搜索</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更为复杂度，为对象添加内部域</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "gb": &#123;</span><br><span class="line">        "tweet": &#123; </span><br><span class="line">            "properties": &#123;</span><br><span class="line">                "tweet": &#123; "type": "text" &#125;,</span><br><span class="line">                "user":  &#123;                      # 域user</span><br><span class="line">                    "type": "object",</span><br><span class="line">                    "dynamic":  true,           # 动态映射，详情查看</span><br><span class="line">                                                # https://www.elastic.co/guide/cn/elasticsearch/guide/current/dynamic-mapping.html#dynamic-mapping</span><br><span class="line">                    "properties": &#123;</span><br><span class="line">                        "id":       &#123; "type": "text" &#125;,</span><br><span class="line">                        "gender":   &#123; "type": "text" &#125;,</span><br><span class="line">                        "age":      &#123; "type": "long"   &#125;,</span><br><span class="line">                        "name":     &#123;           # 子域user.name</span><br><span class="line">                            "type": "object",</span><br><span class="line">                            "properties": &#123;</span><br><span class="line">                                    "full": &#123; "type": "text" &#125;,</span><br><span class="line">                                    "first":&#123; "type": "text" &#125;,</span><br><span class="line">                                    "last": &#123; "type": "text" &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="测试映射-GET-index-analyze"><a href="#测试映射-GET-index-analyze" class="headerlink" title="测试映射: GET /_index/_analyze"></a>测试映射: GET /_index/_analyze</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  "field": "title",</span><br><span class="line">  "text": ["hello", "world"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "tokens" : [</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "hello",</span><br><span class="line">      "start_offset" : 0,</span><br><span class="line">      "end_offset" : 5,</span><br><span class="line">      "type" : "&lt;ALPHANUM&gt;",</span><br><span class="line">      "position" : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "world",</span><br><span class="line">      "start_offset" : 6,</span><br><span class="line">      "end_offset" : 11,</span><br><span class="line">      "type" : "&lt;ALPHANUM&gt;",</span><br><span class="line">      "position" : 101</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><blockquote>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/analysis-intro.html" target="_blank" rel="noopener">Elasticsearch: 权威指南 » 基础入门 » 映射和分析 » 分析与分析器</a></p>
</blockquote>
<h2 id="请求体查询-GET-URL-search-“query”-…"><a href="#请求体查询-GET-URL-search-“query”-…" class="headerlink" title="请求体查询: GET /URL/_search {“query”: {…} }"></a>请求体查询: GET /URL/_search {“query”: {…} }</h2><p>将查询语句传递给<code>query</code>参数</p>
<p>一个典型的结构如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        QUERY_NAME: &#123;</span><br><span class="line">            ARGUMENT: VALUE, </span><br><span class="line">            ...,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查询可分为有评分/无评分的查询，即查询/过滤</p>
<ul>
<li>查询: 是一个评分的查询，除询问“是否匹配”，还需判断匹配程度</li>
<li>过滤: 简单询问“是否匹配”，结果是<code>yes</code>或<code>no</code></li>
</ul>
<p>通常的规则是，使用查询<code>query</code>语句来进行<strong>全文</strong>搜索或者其它任何需要影响<strong>相关性得分</strong>的搜索。除此以外的情况都使用过滤<code>filters</code>。</p>
<h3 id="几个重要的查询"><a href="#几个重要的查询" class="headerlink" title="几个重要的查询"></a>几个重要的查询</h3><h4 id="match-all"><a href="#match-all" class="headerlink" title="match_all"></a>match_all</h4><p>默认的查询方式，简单匹配所有文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br></pre></td></tr></table></figure></p>
<p>等价于<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "match_all": &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="match-multi-match"><a href="#match-multi-match" class="headerlink" title="match/multi_match"></a>match/multi_match</h4><p>可用的标准查询，对任何字段进行全文搜索或精确查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;                      # 查询</span><br><span class="line">        "match": &#123;                  # 匹配</span><br><span class="line">            "tweet": "About Search" # "tweet"域出现"About Search"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在多个字段上执行相同的<code>match</code>查询，例如在<code>&quot;title&quot;, &quot;text&quot;</code>字段搜索出现<code>&quot;blog&quot;</code>的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;                        # 查询</span><br><span class="line">    "multi_match": &#123;                # 多字段查询</span><br><span class="line">      "query": "blog",              # 查询内容</span><br><span class="line">      "fields": ["title", "text"]   # 字段/域</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="term-terms"><a href="#term-terms" class="headerlink" title="term/terms"></a>term/terms</h4><p>用于精确匹配，可以是数字、时间、布尔或<code>not_analyzed</code>的字符串。如查询<code>&quot;title&quot;</code>域中包含<code>&quot;third&quot;</code>的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;              # 查询</span><br><span class="line">        "term": &#123;           # 精确匹配</span><br><span class="line">            "title": "third"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>允许指定多值的精确匹配。例如查询<code>&quot;title&quot;</code>域中包含<code>&quot;first&quot;, &quot;third&quot;, &quot;second&quot;</code>的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "terms": &#123;</span><br><span class="line">            "title": [</span><br><span class="line">                "first", "second", "third"</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h4><p>查询指定字段中有值的文档，例如查询<code>&quot;title&quot;</code>字段不为空的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "exists": &#123;</span><br><span class="line">      "field": "title"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查询指定字段中无值的文档，例如查询<code>&quot;title&quot;</code>字段为空的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must_not": [</span><br><span class="line">        &#123;</span><br><span class="line">          "exists": &#123;</span><br><span class="line">            "field": "title"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><p>查询落在指定区间内的数字或时间，允许的操作符有</p>
<ul>
<li><code>gt</code>: 大于</li>
<li><code>gte</code>: 大于等于</li>
<li><code>lt</code>: 小于</li>
<li><code>lte</code>: 小于等于</li>
</ul>
<p>如年龄域<code>&quot;age&quot;</code>不小于20且小于30的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;              # 查询</span><br><span class="line">        "range": &#123;          # 范围查询</span><br><span class="line">            "age": &#123;        # 年龄域</span><br><span class="line">                "gte": 20,  # 不小于20</span><br><span class="line">                "lt" : 30,  # 大于30</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="组合多个查询"><a href="#组合多个查询" class="headerlink" title="组合多个查询"></a>组合多个查询</h3><p>例如要求查询满足下列条件的文档</p>
<ul>
<li><code>&quot;title&quot;</code>域包含<code>&quot;how to make millions&quot;</code></li>
<li>不能匹配<code>&quot;tag&quot;</code>值为<code>&quot;spam&quot;</code>的文档</li>
<li><code>&quot;tag&quot;</code>值是<code>&quot;starred&quot;</code>的文档最佳</li>
<li>日期<code>&quot;date&quot;</code>在<code>&quot;2014-01-01&quot;</code>之后的文档最佳</li>
</ul>
<blockquote>
<p><strong>注意</strong>：</p>
<ul>
<li>以下查询内需嵌套<a href="#%e5%87%a0%e4%b8%aa%e9%87%8d%e8%a6%81%e7%9a%84%e6%9f%a5%e8%af%a2">几个重要的查询</a></li>
<li>若一个查询内包含多个语句，用<code>[]</code>表示数组，且每个完整的查询包含<code>{}</code>，注意括号使用</li>
</ul>
</blockquote>
<h4 id="must"><a href="#must" class="headerlink" title="must"></a>must</h4><p>文档必须匹配给定条件，才能被匹配成功。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"must": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">        "title": "how to make millions"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="must-not"><a href="#must-not" class="headerlink" title="must_not"></a>must_not</h4><p>文档必须不匹配给定条件，才能被匹配成功。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"must_not": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">        "tag": "spam"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="should"><a href="#should" class="headerlink" title="should"></a>should</h4><p>用于修正每个文档的相关性得分，如果满足任意语句将增加<code>_score</code>，否则无影响。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">"should": [</span><br><span class="line">    &#123;</span><br><span class="line">        "match": &#123;</span><br><span class="line">            "tag": "starred"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        "range": &#123;</span><br><span class="line">            "date": &#123;</span><br><span class="line">                "gte": "2014-01-01"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p>必须匹配，以过滤模式进行，<strong>满足条件的文档被包含</strong>。考虑日期条件写入<code>should</code>会影响文档评分，将其更改为<code>filter</code>匹配<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"filter": &#123;</span><br><span class="line">    "range": &#123;</span><br><span class="line">        "date": &#123;</span><br><span class="line">            "gte": "2014-01-01"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h4><p>通过<code>bool</code>查询将多查询组合在一起<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">        "must": &#123;           # "title"域包含"how to make millions"</span><br><span class="line">            "match": &#123;</span><br><span class="line">                "title": "how to make millions"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "must_not": &#123;       # 不能匹配"tag"值为"spam"的文档</span><br><span class="line">            "match": &#123;</span><br><span class="line">                "tag": "spam"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "should": &#123;         # "tag"值是"starred"或日期"date"在"2014-01-01"之后的文档最佳</span><br><span class="line">            "match": &#123;</span><br><span class="line">                "tag": "starred"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "filter": &#123;         # 不想让日期影响文档评分，将日期条件写入`filter`</span><br><span class="line">            "range": &#123;</span><br><span class="line">                "date": &#123;</span><br><span class="line">                    "gte": "2014-01-01"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="constant-score"><a href="#constant-score" class="headerlink" title="constant_score"></a>constant_score</h4><p>将一个不变的常量评分应用于所有匹配的文档，经常用于只需执行只包含<code>filter</code>查询而没有其他查询(评分查询)的情况<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "constant_score": &#123;</span><br><span class="line">            "filter": &#123;</span><br><span class="line">                "term": &#123;</span><br><span class="line">                    "category": "ebooks"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="验证查询-GET-URL-search-validate-query-explain"><a href="#验证查询-GET-URL-search-validate-query-explain" class="headerlink" title="验证查询: GET /URL/_search/_validate/query?explain"></a>验证查询: GET /URL/_search/_validate/query?explain</h3><p>例如一个错误的查询语句如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    # 正确查询语句如下</span><br><span class="line">    # "match": &#123;</span><br><span class="line">    #   "title": "third"</span><br><span class="line">    # &#125;</span><br><span class="line">    "title": &#123;</span><br><span class="line">      "match": "third"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "root_cause": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type": "parsing_exception",</span><br><span class="line">        "reason": "Unknown key for a VALUE_STRING in [query].",</span><br><span class="line">        "line": 3,</span><br><span class="line">        "col": 5</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "type": "parsing_exception",</span><br><span class="line">    "reason": "Unknown key for a VALUE_STRING in [query].",</span><br><span class="line">    "line": 3,</span><br><span class="line">    "col": 5</span><br><span class="line">  &#125;,</span><br><span class="line">  "status": 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>通过<code>_validate/query</code>验证语句是否合法</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search/_validate/query</span><br><span class="line">&#123;</span><br><span class="line">    "query":</span><br><span class="line">        "title": &#123;</span><br><span class="line">        "match": "third"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "valid" : false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加参数<code>explain</code>输出错误原因</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">    "query":</span><br><span class="line">        "title": &#123;</span><br><span class="line">        "match": "third"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "valid" : false,</span><br><span class="line">    "error" : "org.elasticsearch.common.ParsingException: [_na] query malformed, must start with start_object"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="排序与相关性"><a href="#排序与相关性" class="headerlink" title="排序与相关性"></a>排序与相关性</h2><h3 id="排序-GET-URL-search-“sort”-…"><a href="#排序-GET-URL-search-“sort”-…" class="headerlink" title="排序: GET /URL/_search { “sort”: { … } }"></a>排序: GET /URL/_search { “sort”: { … } }</h3><p>可以将排序语句与搜索语句放入一个<code>GET</code>请求中，即对搜索结果进行排序，例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /URL/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    "sort": &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="按字段值排序"><a href="#按字段值排序" class="headerlink" title="按字段值排序"></a>按字段值排序</h4><p>如根据<code>&quot;date&quot;</code>域排序，将最新的文档放在最前<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": &#123;</span><br><span class="line">      "date": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若不指定顺序，默认升序排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": "date"</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同</span></span><br><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": &#123;</span><br><span class="line">      "date": &#123;</span><br><span class="line">        "order": "asc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "took" : 2,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : &#123;</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "successful" : 5,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "max_score" : null,     # 在排序中，`_score`无意义，故未计算；将track_scores参数设置为true也可计算</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "3",</span><br><span class="line">        "_score" : null,    # 在排序中，`_score`无意义，故未计算；将track_scores参数设置为true也可计算</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My first blog entry",</span><br><span class="line">          "text" : "I am starting to get the hang of this...",</span><br><span class="line">          "date" : "2020/01/02",</span><br><span class="line">          "index" : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort" : [</span><br><span class="line">          1577923200000     # 时间戳，自epoch(January 1, 1970 00:00:00 UTC)以来的毫秒数</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      ...,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "website",</span><br><span class="line">        "_type" : "blog",</span><br><span class="line">        "_id" : "123",</span><br><span class="line">        "_score" : null,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "My updated blog post"</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort" : [</span><br><span class="line">          -9223372036854775808</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      ...,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多级排序"><a href="#多级排序" class="headerlink" title="多级排序"></a>多级排序</h4><p>结合<code>&quot;date&quot;</code>和<code>&quot;_source&quot;</code>进行排序，匹配结果先以日期降序排序，再按索引升序排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "date": "desc"</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "index": "asc"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="多值字段排序"><a href="#多值字段排序" class="headerlink" title="多值字段排序"></a>多值字段排序</h4><p>若指定排序字段包含多个值，这些值没有顺序关系，仅仅是被包装，那么可以通过参数<code>mode</code>将多值处理后进行排序，支持<code>min, max, avg, sum</code>。例如统计各班平均分并按降序排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    "sort": &#123;</span><br><span class="line">        "score": &#123;</span><br><span class="line">            "order": "desc",</span><br><span class="line">            "mode": "avg"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="相关性-score"><a href="#相关性-score" class="headerlink" title="相关性: _score"></a>相关性: _score</h3><p>ES的文档相似度用TF/IDF定义，包括</p>
<ul>
<li>词频：检索词在字段中出现的频率，出现频率越高相关性越高；</li>
<li>反文档频率：检索词在索引中出现的频率，出现频率越高相关性越低；</li>
<li>字段长度准则：字段长度越长，相关性越低。</li>
</ul>
<h2 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a>索引管理</h2><h3 id="创建-PUT-index"><a href="#创建-PUT-index" class="headerlink" title="创建: PUT /_index"></a>创建: PUT /_index</h3><p>希望在索引数据前，分析器和映射已经被建立，那么可以手动创建索引，在请求体中传入设置或类型映射</p>
<blockquote>
<p>在<code>config/elasticsearch.yml</code>中指定<code>action.auto_create_index: false</code>可以禁止自动创建索引</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /index</span><br><span class="line">&#123;</span><br><span class="line">    "settings": &#123; ... any settings ... &#125;,</span><br><span class="line">    "mappings": &#123;</span><br><span class="line">        "type_one": &#123; ... any mappings ... &#125;,</span><br><span class="line">        "type_two": &#123; ... any mappings ... &#125;,</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="settings"><a href="#settings" class="headerlink" title="settings"></a>settings</h4><h5 id="number-of-shards-number-of-replicas"><a href="#number-of-shards-number-of-replicas" class="headerlink" title="number_of_shards/number_of_replicas"></a>number_of_shards/number_of_replicas</h5><p>有连个重要的设置参数</p>
<ul>
<li><code>number_of_shards</code>: 每个索引的主分片数目，默认为5；</li>
<li><code>number_of_replicas</code>: 每个主分片的副本数，默认为1。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /index</span><br><span class="line">&#123;</span><br><span class="line">    "settings": &#123;</span><br><span class="line">        "number_of_shards": 1</span><br><span class="line">        "number_of_replicas": 0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以动态修改副本数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /index/_settings</span><br><span class="line">&#123;</span><br><span class="line">    "number_of_replicas": 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h5><p>设置本索引内的分析器，可以配置为已存在的分析器或自定义，默认情况下为<code>standard</code>分析器，包含以下部分</p>
<ul>
<li><code>standard</code>分词器，通过单词边界分割输入的文本；</li>
<li><code>standard</code>词汇单元过滤器，整理分词器触发的词汇单元；</li>
<li><code>lowercase</code>词汇单元过滤器，转换所有词汇单元为小写；</li>
<li><code>stop</code>词汇单元过滤器，删除停用词(默认禁用)。</li>
</ul>
<p>自定义西语分析器方式如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /spanish_docs</span><br><span class="line">&#123;</span><br><span class="line">    "settings": &#123;                           # 设置</span><br><span class="line">        "analysis": &#123;                       # 分析器设置</span><br><span class="line">            "analyzer": &#123;                   # 分析器</span><br><span class="line">                "es_std": &#123;                 # 分析器名</span><br><span class="line">                    "type":      "standard",# 使用standard分析器</span><br><span class="line">                    "stopwords": "_spanish_"# 设置西语停用词过滤器</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/custom-analyzers.html" target="_blank" rel="noopener">创建一个自定义分析器</a>见详细文档说明。</p>
<h4 id="mappings"><a href="#mappings" class="headerlink" title="mappings"></a>mappings</h4><p>详情查看<a href="#%e6%9b%b4%e6%96%b0%e6%98%a0%e5%b0%84-put-index-%22mappings%22">更新映射: PUT /_index {“mappings”: {…} }</a></p>
<h3 id="删除-DELETE-index"><a href="#删除-DELETE-index" class="headerlink" title="删除: DELETE /_index"></a>删除: DELETE /_index</h3><ul>
<li><p>删除指定索引</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /index</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除多个索引</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE /index_1,index_2</span><br><span class="line">DELETE /index_*</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除全部索引</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_all</span><br><span class="line">DELETE /*</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="深入搜索"><a href="#深入搜索" class="headerlink" title="深入搜索"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/search-in-depth.html" target="_blank" rel="noopener">深入搜索</a></h1><h2 id="结构化搜索"><a href="#结构化搜索" class="headerlink" title="结构化搜索"></a>结构化搜索</h2><p>存储以下数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /my_store/products/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "price" : 10, "productID" : "XHDK-A-1293-#fJ3", "from": null, "count": 10 &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "price" : 20, "productID" : "KDKE-B-9947-#kL5" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "price" : 30, "productID" : "JODL-X-1937-#pV7" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 4 &#125;&#125;</span><br><span class="line">&#123; "price" : 30, "productID" : "QQPX-R-3956-#aD8" &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="精确值查找-term"><a href="#精确值查找-term" class="headerlink" title="精确值查找: term"></a>精确值查找: term</h3><ul>
<li>精确查找时，会使用过滤器<code>filter</code>；</li>
<li>不希望对查询进行评分计算，使用<code>constant_score</code>查询；</li>
<li>精确查询文本时，该域<code>mappings</code>需设置为<code>not_analyzed</code>；</li>
<li>理论上非评分查询<strong>先于</strong>评分查询执行，减少评分计算降低计算成本。</li>
</ul>
<p>删除原有索引，并新建<code>mapping</code>，重新导入数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_store</span><br><span class="line">&#123;</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "products": &#123;</span><br><span class="line">      "properties": &#123;</span><br><span class="line">        "productID": &#123;</span><br><span class="line">          "type": "keyword"   # 注意ES6.x移除`string`</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>精确搜索<code>&quot;productID&quot;</code>为<code>&quot;XHDK-A-1293-#fJ3&quot;</code>的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term": &#123;</span><br><span class="line">          "productID": "XHDK-A-1293-#fJ3"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost": 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="组合过滤器-bool"><a href="#组合过滤器-bool" class="headerlink" title="组合过滤器: bool"></a>组合过滤器: bool</h3><ul>
<li><p>查找<strong>价格为20或<code>&quot;productID&quot;</code>为<code>&quot;XHDK-A-1293-#fJ3&quot;</code>，但价格必定不为30</strong>的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "bool": &#123;       # 组合`should`x2 + `must_not`</span><br><span class="line">          "should": [ </span><br><span class="line">            &#123;</span><br><span class="line">              "term": &#123;</span><br><span class="line">                "price": 30</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              "term": &#123;</span><br><span class="line">                "productID": "XHDK-A-1293-#fJ3"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          "must_not": &#123;</span><br><span class="line">            "term": &#123;</span><br><span class="line">              "price": 30</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查找<strong>满足<code>&quot;productID&quot;</code>为<code>&quot;KDKE-B-9947-#kL5&quot;</code>，或<code>&quot;productID&quot;</code>为<code>&quot;JODL-X-1937-#pV7&quot;</code>且价格为30</strong>的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "bool": &#123;                   # 组合`should`x2</span><br><span class="line">          "should": [</span><br><span class="line">            &#123;</span><br><span class="line">              "term": &#123;</span><br><span class="line">                "productID": "KDKE-B-9947-#kL5"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">              "bool": &#123;             # `must`中为列表，将被展开，对每个元素求取布尔值，因此用`bool`将其包裹，即`must`x2</span><br><span class="line">                "must": [</span><br><span class="line">                  &#123;</span><br><span class="line">                    "term": &#123;</span><br><span class="line">                      "productID": "JODL-X-1937-#pV7"</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;, &#123;</span><br><span class="line">                    "term": &#123;</span><br><span class="line">                      "price": 30</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;  </span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost": 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="精确查找多个值-terms"><a href="#精确查找多个值-terms" class="headerlink" title="精确查找多个值: terms"></a>精确查找多个值: terms</h3><p>注意：</p>
<ul>
<li>文档<strong>包含</strong><code>terms</code>给出列表中的词就会被匹配，而不是<strong>等值</strong>；</li>
<li>若需精确相等，最好的方式是<strong>增加并索引另一个字段</strong>。</li>
</ul>
<ul>
<li>查找价格字段为20或30的文档  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "terms": &#123;</span><br><span class="line">          "price": [</span><br><span class="line">            20, 30</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost": 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="范围-range"><a href="#范围-range" class="headerlink" title="范围: range"></a>范围: range</h3><p>可用于限定<strong>数值、日期、字符串(字典序)</strong>范围进行查询</p>
<ul>
<li>查找价格大于20小于40的文档  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "range": &#123;</span><br><span class="line">          "price": &#123;</span><br><span class="line">            "gt": 20,</span><br><span class="line">            "lt": 40</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost": 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="处理空值-exists"><a href="#处理空值-exists" class="headerlink" title="处理空值: exists"></a>处理空值: exists</h3><p><code>null, [], [null]</code>是等价的，无法存于倒排索引中</p>
<ul>
<li><p>查询<code>&quot;count&quot;</code>域不为空的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "exists": &#123;</span><br><span class="line">          "field": "count"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost": 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询<code>&quot;count&quot;</code>域为空的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /my_store/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "bool": &#123;             # ES6.x移除missing</span><br><span class="line">          "must_not": &#123;</span><br><span class="line">            "exists": &#123;</span><br><span class="line">              "field": "count"</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost": 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h2><p>在全文字段中搜索到最相关的文档，两个最重要的方面是</p>
<ul>
<li>相关性：评价查询与结果间的相关程度，可以是TF/IDF、地理位置邻近、模糊相似，或其他算法；</li>
<li>分析：将文本转换为有区别的、规范化的token，为了1)创建倒排索引；2)查询倒排索引。</li>
</ul>
<p>索引一些数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELETE /my_index </span><br><span class="line"></span><br><span class="line">PUT /my_index</span><br><span class="line">&#123; "settings": &#123; "number_of_shards": 1 &#125;&#125; </span><br><span class="line"></span><br><span class="line">POST /my_index/my_type/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "title": "The quick brown fox" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "title": "The quick brown fox jumps over the lazy dog" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "title": "The quick brown fox jumps over the quick dog" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 4 &#125;&#125;</span><br><span class="line">&#123; "title": "Brown fox brown dog" &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="匹配查询-match"><a href="#匹配查询-match" class="headerlink" title="匹配查询: match"></a>匹配查询: match</h3><ul>
<li>查询<code>&quot;title&quot;</code>中包含<code>&quot;quick&quot;</code>的文档，<code>&quot;title&quot;</code>为<code>&quot;text&quot;</code>类型可被分析(<code>&quot;quick&quot;</code>同<code>&quot;QUICK&quot;</code>等)  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "title": "quick"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="多词查询-match"><a href="#多词查询-match" class="headerlink" title="多词查询: match"></a>多词查询: match</h3><ul>
<li><p>查询<code>&quot;title&quot;</code>中包含<code>&quot;BROWN DOG!&quot;</code>的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "title": "BROWN DOG!"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询匹配<strong>所有词项</strong>的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "title": &#123;                # 域的参数设置</span><br><span class="line">        "query": "BROWN DOG!",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定必须匹配的词项数</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "title": &#123;                # 域的参数设置</span><br><span class="line">        "query": "BROWN DOG!",</span><br><span class="line">        "minimum_should_match": "75%"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="组合查询-bool"><a href="#组合查询-bool" class="headerlink" title="组合查询: bool"></a>组合查询: bool</h3><ul>
<li><p>匹配<strong>出现<code>&quot;quick&quot;</code>，但不出现<code>&quot;lazy&quot;</code>，最佳匹配<code>&quot;brown&quot;, &quot;dog&quot;</code></strong>的文档</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": "quick"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      "must_not": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": "lazy"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ], </span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": "brown dog"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>匹配精度控制</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": "brown fox dog"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ], </span><br><span class="line">      "minimum_should_match": 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="语句权重-boost"><a href="#语句权重-boost" class="headerlink" title="语句权重: boost"></a>语句权重: boost</h3><p>希望为<code>&quot;brown&quot;, &quot;quick&quot;</code>提升更高的权重，即出现这些词的文档比未出现这些词的文档更匹配，可以用<code>should</code>语句如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": "brown quick"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : 4,</span><br><span class="line">    "max_score" : 0.7564473,</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "2",</span><br><span class="line">        "_score" : 0.7564473,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "The quick brown fox jumps over the lazy dog"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "3",</span><br><span class="line">        "_score" : 0.68324494,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "The quick brown fox jumps over the quick dog"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 0.5753642,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "The quick brown fox"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "4",</span><br><span class="line">        "_score" : 0.2810996,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "Brown fox brown dog"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>希望提升<code>&quot;quick&quot;</code>的权重多于<code>&quot;brown&quot;</code></strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": &#123;            # 修改域的参数</span><br><span class="line">              "query": "quick",</span><br><span class="line">              "boost": 3 </span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123; </span><br><span class="line">            "title": &#123;</span><br><span class="line">              "query": "brown",</span><br><span class="line">              "boost": 2</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : 4,</span><br><span class="line">    "max_score" : 2.111807,</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "2",</span><br><span class="line">        "_score" : 2.111807,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "The quick brown fox jumps over the lazy dog"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "3",</span><br><span class="line">        "_score" : 1.7620528,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "The quick brown fox jumps over the quick dog"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 1.4384105,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "The quick brown fox"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "4",</span><br><span class="line">        "_score" : 0.5621992,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "Brown fox brown dog"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="控制分析-GET-URL-index-analyze-“field”-…-“text”-…"><a href="#控制分析-GET-URL-index-analyze-“field”-…-“text”-…" class="headerlink" title="控制分析: GET /URL/_index/_analyze { “field”: …, “text”: … }"></a>控制分析: GET /URL/_index/_analyze { “field”: …, “text”: … }</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  "field": "title",</span><br><span class="line">  "text": [</span><br><span class="line">    "The quick brown fox jumps over the lazy dog",</span><br><span class="line">    "The quick brown fox jumps over the quick dog"</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多字段查询"><a href="#多字段查询" class="headerlink" title="多字段查询"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/multi-field-search.html" target="_blank" rel="noopener">多字段查询</a></h2><h3 id="多字段查询-multi-match"><a href="#多字段查询-multi-match" class="headerlink" title="多字段查询: multi_match"></a>多字段查询: multi_match</h3><p>注意：将<code>not_analyzed</code>字段与<code>multi_match</code>中<code>analyzed</code>字段混在一起没有多大用处。在<code>multi_match</code>查询中避免使用<code>not_analyzed</code>字段。</p>
<p>在<code>&quot;title&quot;</code>和<code>&quot;body&quot;</code>字段搜索<code>&quot;Quick brown fox&quot;</code>，最低<code>should</code>匹配30%，可写作<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;         # `should`x2</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "body": &#123;</span><br><span class="line">              "query": "Quick brown fox",</span><br><span class="line">              "minimum_should_match": "30%"</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": &#123;</span><br><span class="line">              "query": "Quick brown fox",</span><br><span class="line">              "minimum_should_match": "30%"</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>可简写为</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "multi_match": &#123;</span><br><span class="line">      "query": "Quick brown fox",</span><br><span class="line">      "fields": ["title", "body"],</span><br><span class="line">      "minimum_should_match": "30%"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用<code>^boost</code>为<code>&quot;body&quot;</code>字段提升权重</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "multi_match": &#123;</span><br><span class="line">      "query": "Quick brown fox",</span><br><span class="line">      "fields": ["title", "body^2"],</span><br><span class="line">      "minimum_should_match": "30%"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>若在<code>&quot;book_title&quot;, &quot;chapter_title&quot;</code>等字段中搜索，可将<code>fields</code>参数指定为</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "multi_match": &#123;</span><br><span class="line">      "query": "Quick brown fox",</span><br><span class="line">      "fields": "*_title"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="最佳字段-best-fields-dis-max"><a href="#最佳字段-best-fields-dis-max" class="headerlink" title="最佳字段(best_fields): dis_max"></a>最佳字段(best_fields): dis_max</h3><p>考虑以下两个文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/my_type/1</span><br><span class="line">&#123;</span><br><span class="line">    "title": "Quick brown rabbits",</span><br><span class="line">    "body":  "Brown rabbits are commonly seen."</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/my_type/2</span><br><span class="line">&#123;</span><br><span class="line">    "title": "Keeping pets healthy",</span><br><span class="line">    "body":  "My quick brown fox eats rabbits on a regular basis."</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个文档简单判断有如下特点</p>
<ul>
<li>文档1两个字段中都包含<code>&quot;brown&quot;</code>，但不包含<code>&quot;fox&quot;</code>；</li>
<li>文档2的<code>&quot;body&quot;</code>字段包含<code>&quot;brown&quot;, &quot;fox&quot;</code>两个词</li>
</ul>
<p>那么文档2匹配度可能会更高，当用<code>match</code>进行匹配<code>&quot;Brown fox&quot;</code>时，产生如下结果<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "multi_match": &#123;          # 多字段匹配</span><br><span class="line">      "query": "Brown fox",</span><br><span class="line">      "fields": ["title", "body"]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "2",</span><br><span class="line">        "_score" : 0.5753642,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "Keeping pets healthy",</span><br><span class="line">          "body" : "My quick brown fox eats rabbits on a regular basis."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 0.5753642,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "Quick brown rabbits",</span><br><span class="line">          "body" : "Brown rabbits are commonly seen."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>产生的结果是两者匹配度是一致的，这是因为<code>bool</code>计算评分方式如下</p>
<ol>
<li>执行<code>should</code>语句中多个查询，得到各个查询的评分；</li>
<li>求取各个评分的均值作为文档查询评分。</li>
</ol>
<p>可以采用<strong>分离最大化查询语句</strong><code>dis_max</code>进行查询，将任何与任一查询匹配的文档作为结果返回，但只将<strong>最佳匹配的评分</strong>作为查询的评分结果返回<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "dis_max": &#123;              # 分离最大化查询</span><br><span class="line">      "queries": [            # 查询列表</span><br><span class="line">        &#123;</span><br><span class="line">          "multi_match": &#123;</span><br><span class="line">            "query": "Brown fox",</span><br><span class="line">            "fields": ["title", "body"]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">..., </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "2",</span><br><span class="line">        "_score" : 0.5753642,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "Keeping pets healthy",</span><br><span class="line">          "body" : "My quick brown fox eats rabbits on a regular basis."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "my_index",</span><br><span class="line">        "_type" : "my_type",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 0.2876821,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "title" : "Quick brown rabbits",</span><br><span class="line">          "body" : "Brown rabbits are commonly seen."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<hr>
<p>指定<code>tie_breaker</code>参数将其他匹配语句评分也考虑其中</p>
<ol>
<li>获得最佳匹配语句的评分<code>_score</code>;</li>
<li>将其他匹配语句的评分结果与<code>tie_breaker</code>相乘;</li>
<li>对以上评分求和并规范化。</li>
</ol>
<p><code>tie_breaker</code> 可以是 0 到 1 之间的浮点数，其中 0 代表使用 dis_max 最佳匹配语句的普通逻辑， 1 表示所有匹配语句同等重要。最佳的精确值需要根据数据与查询调试得出，但是合理值应该与零接近（处于 0.1 - 0.4 之间），这样就不会颠覆 <code>dis_max</code> 最佳匹配性质的根本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "dis_max": &#123;  </span><br><span class="line">      "queries": [      </span><br><span class="line">        &#123;</span><br><span class="line">          "multi_match": &#123;</span><br><span class="line">            "query": "Brown fox",</span><br><span class="line">            "fields": ["title", "body"]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      "tie_breaker": 0.3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多数字段-most-fields-field-subField"><a href="#多数字段-most-fields-field-subField" class="headerlink" title="多数字段(most_fields): field.subField"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/most-fields.html" target="_blank" rel="noopener">多数字段(most_fields)</a>: field.subField</h3><p>可以在某字段(域)添加子字段，如希望在查找时，<strong>用不同的分析器对某字段进行分析</strong>，定义<code>_mappings</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    "settings": &#123; "number_of_shards": 1 &#125;, </span><br><span class="line">    "mappings": &#123;</span><br><span class="line">        "my_type": &#123;</span><br><span class="line">            "properties": &#123;</span><br><span class="line">                "title": &#123; </span><br><span class="line">                    "type":     "string",</span><br><span class="line">                    "analyzer": "english",</span><br><span class="line">                    "fields": &#123;</span><br><span class="line">                        "std":   &#123;                # 字段`title.std`</span><br><span class="line">                            "type":     "string",</span><br><span class="line">                            "analyzer": "standard"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查询时可以对字段及其子字段进行查询，将<code>type</code>设置为<code>most_fields</code>，希望将所有匹配字段的<strong>评分合并</strong>起来，所以使用<code>most_fields</code>类型。这让<code>multi_match</code>查询用<code>bool</code>查询将两个字段语句包在里面，而不是使用<code>dis_max</code>查询。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">   "query": &#123;</span><br><span class="line">        "multi_match": &#123;</span><br><span class="line">            "query":  "jumping rabbits",</span><br><span class="line">            "type":   "most_fields", </span><br><span class="line">            "fields": [ "title", "title.std" ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="跨字段-cross-fields-filed1-…-filedn"><a href="#跨字段-cross-fields-filed1-…-filedn" class="headerlink" title="跨字段(cross_fields): filed1, …, filedn"></a>跨字段(cross_fields): filed1, …, filedn</h3><p>某些实体需要多个字段唯一标识信息，如地址<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "street":   "5 Poland Street",</span><br><span class="line">    "city":     "London",</span><br><span class="line">    "country":  "United Kingdom",</span><br><span class="line">    "postcode": "W1V 3DG"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用<code>multi_match</code>进行查询，并将<code>type</code>设置为<code>most_fields</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "multi_match": &#123;</span><br><span class="line">      "query":       "Poland Street W1V",</span><br><span class="line">      "type":        "most_fields",</span><br><span class="line">      "fields":      [ "street", "city", "country", "postcode" ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="all字段-copy-to"><a href="#all字段-copy-to" class="headerlink" title="_all字段: copy_to"></a>_all字段: copy_to</h3><p>在创建索引<code>mappings</code>时，可将部分字段的值“复制”，如下，<code>first_name</code>和<code>last_name</code>的映射并不影响<code>full_name</code>如何被索引，<code>full_name</code>将两个字段的内容复制到本地，然后根据<code>full_name</code>的映射自行索引。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    "mappings": &#123;</span><br><span class="line">        "person": &#123;</span><br><span class="line">            "properties": &#123;</span><br><span class="line">                "first_name": &#123;</span><br><span class="line">                    "type":     "string",</span><br><span class="line">                    "copy_to":  "full_name" </span><br><span class="line">                &#125;,</span><br><span class="line">                "last_name": &#123;</span><br><span class="line">                    "type":     "string",</span><br><span class="line">                    "copy_to":  "full_name" </span><br><span class="line">                &#125;,</span><br><span class="line">                "full_name": &#123;</span><br><span class="line">                    "type":     "string"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="近似匹配"><a href="#近似匹配" class="headerlink" title="近似匹配"></a>近似匹配</h2><h3 id="短语匹配-match-phrase"><a href="#短语匹配-match-phrase" class="headerlink" title="短语匹配: match_phrase"></a>短语匹配: match_phrase</h3><ul>
<li><p>找到彼此邻近搜索词的查询，例如匹配短语<code>&quot;quick brown fox&quot;</code></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase": &#123;</span><br><span class="line">      "title": "quick brown fox"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加<code>slop</code>参数近似短语匹配</p>
<p>  词条相隔多远时仍然能将文档视为匹配,相隔多远的意思是<strong>为了让查询和文档匹配你需要移动词条多少次</strong>，通过设置一个像50或者100这样的高<code>slop</code>值能够排除单词距离太远的文档，但是也给予了那些单词临近的的文档更高的分数</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase": &#123;</span><br><span class="line">      "title": &#123;</span><br><span class="line">        "query": "quick brown fox",</span><br><span class="line">        "slop": 3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用邻近度提高相关度</p>
<p>  考虑到短语匹配需要全部词条出现在文中中，这要求显然过高，因为在7个词条中若6条匹配，那么相似度就很高了，所以可以将<code>match_phrase</code>放入<code>should</code>语句，以邻近度提升文档的相关度</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match": &#123;</span><br><span class="line">            "title": "dog"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "match_phrase": &#123;</span><br><span class="line">            "title": &#123;</span><br><span class="line">              "query": "quick brown fox",</span><br><span class="line">              "slop": 3</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="结果集重新评分-rescore"><a href="#结果集重新评分-rescore" class="headerlink" title="结果集重新评分: rescore"></a>结果集重新评分: rescore</h3><p>用<code>rescore</code>API对一次简单的<code>match</code>匹配结果顶部文档重新评分并排序，以给同时匹配短语查询的文档一个额外的相关度升级，例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;               # match简单查询</span><br><span class="line">        "match": &#123;  </span><br><span class="line">            "title": &#123;</span><br><span class="line">                "query":                "quick brown fox",</span><br><span class="line">                "minimum_should_match": "30%"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "rescore": &#123;            # 重新评分</span><br><span class="line">        "window_size": 50,  # 每一分片进行重新评分的顶部文档数量</span><br><span class="line">        "query": &#123;          # 定制另一个查询进行重新评分</span><br><span class="line">            "rescore_query": &#123;</span><br><span class="line">                "match_phrase": &#123;</span><br><span class="line">                    "title": &#123;</span><br><span class="line">                        "query": "quick brown fox",</span><br><span class="line">                        "slop":  50</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="相关词-shingles-Ngrams"><a href="#相关词-shingles-Ngrams" class="headerlink" title="相关词: shingles/Ngrams"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/shingles.html" target="_blank" rel="noopener">相关词: shingles/Ngrams</a></h3><p>用<code>Ngrams</code>进行匹配以提高相关性。</p>
<h2 id="部分匹配"><a href="#部分匹配" class="headerlink" title="部分匹配"></a>部分匹配</h2><p>创建索引如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    "mappings": &#123;</span><br><span class="line">        "address": &#123;</span><br><span class="line">            "properties": &#123;</span><br><span class="line">                "postcode": &#123;</span><br><span class="line">                    "type":  "keyword"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>索引一些数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/address/_bulk</span><br><span class="line">&#123;"index": &#123;"_id": 1&#125;&#125;</span><br><span class="line">&#123; "postcode": "W1V 3DG" &#125;</span><br><span class="line">&#123;"index": &#123;"_id": 2&#125;&#125;</span><br><span class="line">&#123; "postcode": "W2F 8HW" &#125;</span><br><span class="line">&#123;"index": &#123;"_id": 3&#125;&#125;</span><br><span class="line">&#123; "postcode": "W1F 7HW" &#125;</span><br><span class="line">&#123;"index": &#123;"_id": 4&#125;&#125;</span><br><span class="line">&#123; "postcode": "WC1N 1LZ" &#125;</span><br><span class="line">&#123;"index": &#123;"_id": 5&#125;&#125;</span><br><span class="line">&#123; "postcode": "SW5 0BE" &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="前缀查询-prefix"><a href="#前缀查询-prefix" class="headerlink" title="前缀查询: prefix"></a>前缀查询: prefix</h3><p>查找所有以<code>W1</code>开始的邮编<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "prefix": &#123;</span><br><span class="line">      "postcode": &#123;</span><br><span class="line">        "value": "W1"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="前缀短语匹配-match-phrase-prefix"><a href="#前缀短语匹配-match-phrase-prefix" class="headerlink" title="前缀短语匹配: match_phrase_prefix"></a>前缀短语匹配: match_phrase_prefix</h3><p>可通过前缀短语匹配查询，<strong>注意<code>not_analyzed</code>的字段不能被匹配成功</strong>。<br>例如某文档存在字段<code>&quot;info&quot;: &quot;somebody&#39;s home&quot;</code>，可以通过如下查找<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase_prefix&quot;: &#123;</span><br><span class="line">      &quot;info&quot;: &quot;somebody&apos;s h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="通配符查询-wildcard"><a href="#通配符查询-wildcard" class="headerlink" title="通配符查询: wildcard"></a>通配符查询: wildcard</h3><p>允许指定匹配的正则式。它使用标准的shell通配符查询： </p>
<ul>
<li><code>?</code>匹配任意字符；</li>
<li><code>*</code>匹配0或多个字符。</li>
</ul>
<p>匹配包含<code>W1F 7HW</code>和<code>W2F 8HW</code>的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "wildcard": &#123;</span><br><span class="line">            "postcode": "W?F*HW" </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="正则表达式查询-regexp"><a href="#正则表达式查询-regexp" class="headerlink" title="正则表达式查询: regexp"></a>正则表达式查询: regexp</h3><p>只匹配<code>W</code>区域所有邮编，但是<a href="#%e9%80%9a%e9%85%8d%e7%ac%a6%e6%9f%a5%e8%af%a2-wildcard">通配符查询: wildcard</a>中查询语句也会匹配<code>WC</code>开头得邮编，那么用正则表达式匹配可以处理这种复杂的情况<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "regexp": &#123;</span><br><span class="line">            "postcode": "W[0-9].+" </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="控制相关度"><a href="#控制相关度" class="headerlink" title="控制相关度"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/controlling-relevance.html" target="_blank" rel="noopener">控制相关度</a></h2><h1 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/aggregations.html" target="_blank" rel="noopener">聚合</a></h1><p>索引一些数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /cars/transactions/_bulk</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 10000, "color" : "red", "make" : "honda", "sold" : "2014-10-28" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 20000, "color" : "red", "make" : "honda", "sold" : "2014-11-05" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 30000, "color" : "green", "make" : "ford", "sold" : "2014-05-18" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 15000, "color" : "blue", "make" : "toyota", "sold" : "2014-07-02" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 12000, "color" : "green", "make" : "toyota", "sold" : "2014-08-19" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 20000, "color" : "red", "make" : "honda", "sold" : "2014-11-05" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 80000, "color" : "red", "make" : "bmw", "sold" : "2014-01-01" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 25000, "color" : "blue", "make" : "ford", "sold" : "2014-02-12" &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="尝试聚合"><a href="#尝试聚合" class="headerlink" title="尝试聚合"></a>尝试聚合</h2><h3 id="命令格式-GET-URL-search-“aggs”-“NAME”-AGG-TYPE-…"><a href="#命令格式-GET-URL-search-“aggs”-“NAME”-AGG-TYPE-…" class="headerlink" title="命令格式: GET /URL/_search { “aggs”: { “NAME”: { AGG_TYPE: { … } } } }"></a>命令格式: GET /URL/_search { “aggs”: { “NAME”: { AGG_TYPE: { … } } } }</h3><p>聚合语句的典型命令格式如下，一个聚合语句内只包含一个<code>AGG_TYPE</code>，包含其余聚合语句时嵌套<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /URL/_search</span><br><span class="line">&#123;</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "NAME": &#123;</span><br><span class="line">      "AGG_TYPE": &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "NAME": &#123;</span><br><span class="line">          "AGG_TYPE": &#123;</span><br><span class="line">            ...</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="简单例子-terms-avg-max-min"><a href="#简单例子-terms-avg-max-min" class="headerlink" title="简单例子: terms, avg, max, min"></a>简单例子: terms, avg, max, min</h3><ul>
<li><p>根据颜色分桶<strong>计数</strong></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ------------ 新增 ------------</span></span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # 聚合语句，根据颜色进行分桶计数</span><br><span class="line">    "popular_colors": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ------------ 新增 ------------</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  得到错误</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "root_cause": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type": "illegal_argument_exception",</span><br><span class="line">        "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [color] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    ...,</span><br><span class="line">  &#125;,</span><br><span class="line">  "status": 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  原因见<a href="https://www.cnblogs.com/shsgshn/p/11535849.html" target="_blank" rel="noopener">ES报错：”illegal_argument_exception” - cnblogs</a>，应修改为</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "popular_colors": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  </span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "popular_colors" : &#123;</span><br><span class="line">      "doc_count_error_upper_bound" : 0,</span><br><span class="line">      "sum_other_doc_count" : 0,</span><br><span class="line">      "buckets" : [         # 分桶信息</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "red",</span><br><span class="line">          "doc_count" : 4   # 红色总计4辆</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "blue",</span><br><span class="line">          "doc_count" : 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "green",</span><br><span class="line">          "doc_count" : 2</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>计算<strong>每种颜色车的价格均值</strong></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # 聚合语句，根据颜色进行分桶计数</span><br><span class="line">    "popular_colors": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      # ------------ 新增 ------------</span><br><span class="line">      # 嵌套聚合语句，在颜色分桶内计算均值</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "average_price_of_color": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      # ------------ 新增 ------------</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  </span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "popular_colors" : &#123;</span><br><span class="line">      "doc_count_error_upper_bound" : 0,</span><br><span class="line">      "sum_other_doc_count" : 0,</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "red",</span><br><span class="line">          "doc_count" : 4,        # 红色总计4辆</span><br><span class="line">          "average_price_of_color" : &#123;</span><br><span class="line">            "value" : 32500.0     # 红色分桶内价格均值</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加<strong>每种颜色车制造厂商</strong>信息</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # 聚合语句，根据颜色进行分桶计数</span><br><span class="line">    "popular_colors": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        # 嵌套聚合语句，在颜色分桶内计算均值</span><br><span class="line">        "average_price_of_color": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        # ------------ 新增 ------------</span><br><span class="line">        # 嵌套聚合语句，在颜色分桶内统计制造厂商</span><br><span class="line">        "the_maker_of_the_car_of_this_color": &#123;</span><br><span class="line">          "terms": &#123;</span><br><span class="line">            "field": "make.keyword"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        # ------------ 新增 ------------</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "popular_colors" : &#123;</span><br><span class="line">      "doc_count_error_upper_bound" : 0,</span><br><span class="line">      "sum_other_doc_count" : 0,</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "red",</span><br><span class="line">          "doc_count" : 4,        # 红色总计4辆</span><br><span class="line">          "the_maker_of_the_car_of_this_color" : &#123;</span><br><span class="line">            "doc_count_error_upper_bound" : 0,</span><br><span class="line">            "sum_other_doc_count" : 0,</span><br><span class="line">            "buckets" : [         # 红色分桶内，按制造厂商分桶</span><br><span class="line">              &#123;</span><br><span class="line">                "key" : "honda",</span><br><span class="line">                "doc_count" : 3   # honda制造3辆</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                "key" : "bmw",</span><br><span class="line">                "doc_count" : 1   # bwm制造3辆</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          "average_price_of_color" : &#123;</span><br><span class="line">            "value" : 32500.0     # 红色分桶内价格均值</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加<strong>每种颜色、每种厂商制造的车的价格最高、最低价格</strong>信息</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # 聚合语句，根据颜色进行分桶计数</span><br><span class="line">    "popular_colors": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        # 嵌套聚合语句，在颜色分桶内计算均值</span><br><span class="line">        "average_price_of_color": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        # 嵌套聚合语句，在颜色分桶内统计制造厂商</span><br><span class="line">        "the_maker_of_the_car_of_this_color": &#123;</span><br><span class="line">          "terms": &#123;</span><br><span class="line">            "field": "make.keyword"</span><br><span class="line">          &#125;,</span><br><span class="line">          # ------------ 新增 ------------</span><br><span class="line">          "aggs": &#123;</span><br><span class="line">            # 嵌套聚合语句的嵌套聚合语句，在颜色分桶、制造厂商子分桶内计算价格最小值</span><br><span class="line">            "minimal_price_of_this_color_of_this_maker": &#123;</span><br><span class="line">              "min": &#123;</span><br><span class="line">                "field": "price"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            # 嵌套聚合语句的嵌套聚合语句，在颜色分桶、制造厂商子分桶内计算价格最大值</span><br><span class="line">            "maximal_price_of_this_color_of_this_maker": &#123;</span><br><span class="line">              "max": &#123;</span><br><span class="line">                "field": "price"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          # ------------ 新增 ------------</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "popular_colors" : &#123;</span><br><span class="line">      "doc_count_error_upper_bound" : 0,</span><br><span class="line">      "sum_other_doc_count" : 0,</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "red",</span><br><span class="line">          "doc_count" : 4,              # 红色总计4辆</span><br><span class="line">          "the_maker_of_the_car_of_this_color" : &#123;       </span><br><span class="line">            "doc_count_error_upper_bound" : 0,</span><br><span class="line">            "sum_other_doc_count" : 0,</span><br><span class="line">            "buckets" : [               # 红色分桶内，按制造厂商分桶</span><br><span class="line">              &#123;</span><br><span class="line">                "key" : "honda",</span><br><span class="line">                "doc_count" : 3,        # honda制造3辆</span><br><span class="line">                "maximal_price_of_this_color_of_this_maker" : &#123;</span><br><span class="line">                  "value" : 20000.0     # 红色车、honda制造，价格最大值</span><br><span class="line">                &#125;,</span><br><span class="line">                "minimal_price_of_this_color_of_this_maker" : &#123;</span><br><span class="line">                  "value" : 10000.0     # 红色车、honda制造，价格最小值</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              </span><br><span class="line">              ...</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          "average_price_of_color" : &#123;</span><br><span class="line">            "value" : 32500.0           # 红色分桶内价格均值</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="限定聚合范围-query-global"><a href="#限定聚合范围-query-global" class="headerlink" title="限定聚合范围: query, global"></a>限定聚合范围: query, global</h2><p>在上面例子中，未进行<code>query</code>请求，所以默认是对所有文档进行聚合的。<code>aggs</code>可以和<code>query</code>同时使用，也就是说，聚合是基于我们查询匹配的文档集合进行计算的。</p>
<ul>
<li>计算<code>honda</code>生产的汽车各颜色的价格的所有统计量  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ----- 查询honda汽车 ----- </span></span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "make": &#123;</span><br><span class="line">        "value": "honda"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ----- 查询honda汽车 ----- </span></span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # ----- 以颜色分桶 ------</span><br><span class="line">    "color_of_cars": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        # -- 该颜色价格统计量 --</span><br><span class="line">        "all_stats_of_cars_with_this_color": &#123;</span><br><span class="line">          "extended_stats": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        # -- 该颜色价格统计量 --</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    # ----- 以颜色分桶 ------</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>但有时也想在获得子集的同时，得到所有对象的聚合结果，如下</p>
<ul>
<li><p>统计<code>honda</code>汽车均值与所有汽车售价均值的对比，可以用查询获得子集计算普通聚合，再用<strong>全局桶</strong>获取全部汽车售价均值</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0, </span><br><span class="line"><span class="meta">  #</span><span class="bash"> ----- 查询honda汽车 ----- </span></span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "make": &#123;</span><br><span class="line">        "value": "honda"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ----- 查询honda汽车 ----- </span></span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # ---- honda汽车均值 ----</span><br><span class="line">    "average_price_of_honda": &#123;</span><br><span class="line">      "avg": &#123;</span><br><span class="line">        "field": "price"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    # ---- honda汽车均值 ----</span><br><span class="line">    # ----- 全部汽车统计 ----</span><br><span class="line">    "all_maker": &#123;</span><br><span class="line">      "global": &#123;&#125;,   # 全局桶，无参数</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        # -- 全部汽车均值 ---</span><br><span class="line">        "average_price_of_all_maker": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        # -- 全部汽车均值 ---</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    # ----- 全部汽车统计 ----</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="直方图统计-histogram"><a href="#直方图统计-histogram" class="headerlink" title="直方图统计: histogram"></a>直方图统计: histogram</h2><ul>
<li><p>对价格进行直方图统计</p>
<p>  以间隔20000对车价格进行直方图统计</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "histogram_of_price": &#123;</span><br><span class="line">      "histogram": &#123;        # 直方图统计</span><br><span class="line">        "field": "price",</span><br><span class="line">        "interval": 20000   # 间隔20000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "histogram_of_price" : &#123;</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : 0.0,        # 区间下界，代表0 ~ 19,999</span><br><span class="line">          "doc_count" : 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : 20000.0,</span><br><span class="line">          "doc_count" : 4</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : 40000.0,</span><br><span class="line">          "doc_count" : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : 60000.0,</span><br><span class="line">          "doc_count" : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : 80000.0,</span><br><span class="line">          "doc_count" : 1</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>求取每个价格区间车辆总价</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "histogram_of_price": &#123;</span><br><span class="line">      "histogram": &#123;        # 直方图统计</span><br><span class="line">        "field": "price",</span><br><span class="line">        "interval": 20000   # 间隔20000</span><br><span class="line">      &#125;,</span><br><span class="line">      # ------------ 新增 ------------</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "sum_of_price_in_this_bin": &#123;</span><br><span class="line">          "sum": &#123;          # 求和</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      # ------------ 新增 ------------</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "histogram_of_price" : &#123;</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : 0.0,</span><br><span class="line">          "doc_count" : 3,</span><br><span class="line">          "sum_of_price_in_this_bin" : &#123;</span><br><span class="line">            "value" : 37000.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="统计量计算-extended-stats"><a href="#统计量计算-extended-stats" class="headerlink" title="统计量计算: extended_stats"></a>统计量计算: extended_stats</h2><p>关于每个厂商车的价格所有统计量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "the_maker_of_cars": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "make.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      # ----------- 新增 -----------</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "stats_of_price_of_this_maker": &#123;</span><br><span class="line">          "extended_stats": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      # ----------- 新增 -----------</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  </span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "the_maker_of_cars" : &#123;</span><br><span class="line">      "doc_count_error_upper_bound" : 0,</span><br><span class="line">      "sum_other_doc_count" : 0,</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key" : "honda",</span><br><span class="line">          "doc_count" : 3,</span><br><span class="line">          "stats_of_price_of_this_maker" : &#123;</span><br><span class="line">            "count" : 3,</span><br><span class="line">            "min" : 10000.0,</span><br><span class="line">            "max" : 20000.0,</span><br><span class="line">            "avg" : 16666.666666666668,</span><br><span class="line">            "sum" : 50000.0,</span><br><span class="line">            "sum_of_squares" : 9.0E8,</span><br><span class="line">            "variance" : 2.222222222222221E7,</span><br><span class="line">            "std_deviation" : 4714.045207910315,</span><br><span class="line">            "std_deviation_bounds" : &#123;</span><br><span class="line">              "upper" : 26094.757082487296,</span><br><span class="line">              "lower" : 7238.5762508460375</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="按时间统计-date-histogram"><a href="#按时间统计-date-histogram" class="headerlink" title="按时间统计: date_histogram"></a>按时间统计: date_histogram</h2><ul>
<li><p>根据销售时间，统计每月售出数目和总价</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "sold_every_month": &#123;</span><br><span class="line">      "date_histogram": &#123;       # 按时间求直方图</span><br><span class="line">        "field": "sold",        </span><br><span class="line">        "interval": "month",    # 按月</span><br><span class="line">        "format": "yyyy-MM-dd"  # 指定时间格式(可选)</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "totally_sold_price_in_this_month": &#123;</span><br><span class="line">          "sum": &#123;              # 计算每个月售出总价</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "sold_every_month" : &#123;</span><br><span class="line">      "buckets" : [</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string" : "2014-01-01",</span><br><span class="line">          "key" : 1388534400000,</span><br><span class="line">          "doc_count" : 1,</span><br><span class="line">          "totally_sold_price_in_this_month" : &#123;</span><br><span class="line">            "value" : 80000.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ...,</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string" : "2014-11-01",</span><br><span class="line">          "key" : 1414800000000,</span><br><span class="line">          "doc_count" : 2,</span><br><span class="line">          "total_sold_price" : &#123;</span><br><span class="line">            "value" : 40000.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不忽略空桶</p>
<p>  可以看到上面输出中并不包含<code>2014-01-01 ~ 2014-12-31</code>全年，因为统计为空的桶被忽略了，可指定如下两个参数强制返回空桶，并返回全年信息</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "sold_every_month": &#123;</span><br><span class="line">      "date_histogram": &#123;</span><br><span class="line">        "field": "sold",</span><br><span class="line">        "interval": "month", </span><br><span class="line">        "format": "yyyy-MM-dd",</span><br><span class="line">        # ------- 新增 -------</span><br><span class="line">        "min_doc_count": 0,     # 强制返回空桶</span><br><span class="line">        "extended_bounds": &#123;    # 强制返回该日期范围内的桶</span><br><span class="line">          "min": "2014-01-01",</span><br><span class="line">          "max": "2014-12-31"</span><br><span class="line">        &#125;</span><br><span class="line">        # ------- 新增 -------</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "total_sold_price": &#123;</span><br><span class="line">          "sum": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>按季度展示所有汽车品牌总销售额</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "sold_per_quarter": &#123;</span><br><span class="line">      # --- 按季度统计直方图 ---</span><br><span class="line">      "date_histogram": &#123;</span><br><span class="line">        "field": "sold",</span><br><span class="line">        "interval": "quarter",</span><br><span class="line">        "format": "yyyy-MM-dd",</span><br><span class="line">        "min_doc_count": 0,</span><br><span class="line">        "extended_bounds": &#123;</span><br><span class="line">          "min": "2014-01-01",</span><br><span class="line">          "max": "2014-12-31"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        # --- 统计每个季度总销售额 ---</span><br><span class="line">        "total_sold_in_this_quarter": &#123;</span><br><span class="line">          "sum": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        # --- 统计每个季度总销售额 ---</span><br><span class="line">        # -------- 按品牌分箱 -------</span><br><span class="line">        "sold_of_maker": &#123;</span><br><span class="line">          "terms": &#123;</span><br><span class="line">            "field": "make.keyword"</span><br><span class="line">          &#125;,</span><br><span class="line">          # ---- 求该品牌总销售额 ----</span><br><span class="line">          "aggs": &#123;</span><br><span class="line">            "sum_of_sold_price_of_this_maker": &#123;</span><br><span class="line">              "sum": &#123;</span><br><span class="line">                "field": "price"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          # ---- 求该品牌总销售额 ----</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        # -------- 按品牌分箱 -------</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      # --- 按季度统计直方图 ---</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="过滤和聚合"><a href="#过滤和聚合" class="headerlink" title="过滤和聚合"></a>过滤和聚合</h2><h3 id="查询过滤-“query”-…-“filter”-…"><a href="#查询过滤-“query”-…-“filter”-…" class="headerlink" title="查询过滤: “query”: { …, “filter”, … }"></a>查询过滤: “query”: { …, “filter”, … }</h3><p>在查询过程中设置过滤条件，同时影响搜索和聚合结果</p>
<ul>
<li><p>售价在10000美元之上的汽车计算其均值</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0, </span><br><span class="line">  "query": &#123;            # 过滤查询</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "range": &#123;</span><br><span class="line">          "price": &#123;</span><br><span class="line">            "gt": 10000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ------------------------</span></span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "average_price_of_cars": &#123;</span><br><span class="line">      "avg": &#123;</span><br><span class="line">        "field": "price"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="聚合过滤-“aggs”-…-“filter”-…"><a href="#聚合过滤-“aggs”-…-“filter”-…" class="headerlink" title="聚合过滤: “aggs”: { …, “filter”, … }"></a>聚合过滤: “aggs”: { …, “filter”, … }</h3><p>只想<strong>对聚合结果进行过滤</strong>时，在聚合语句<code>aggs</code>中设置过滤条件，影响聚合</p>
<ul>
<li>统计<code>honda</code>汽车2014年下半年售出的车的均值，但是<strong>要求查询结果返回全部honda的文档</strong>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "make": &#123;</span><br><span class="line">        "value": "honda"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ---------------------------------------</span></span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "cars_sold_in_2014_M6_to_M12": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "range": &#123;</span><br><span class="line">          "sold": &#123;</span><br><span class="line">            "from": "2014-07-01",</span><br><span class="line">            "to": "2014-12-31"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      # -----------------------------------</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "average_price_of_cars_sold_in_2014_M6_to_M12": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="后过滤器-post-filter"><a href="#后过滤器-post-filter" class="headerlink" title="后过滤器: post_filter"></a>后过滤器: post_filter</h3><p>用后过滤器(<code>post_filter</code>)<strong>只过滤搜索结果而不过滤聚合结果</strong>，只影响搜索结果</p>
<ul>
<li><p>统计<code>honda</code>汽车2014年下半年售出的车均值，但是<strong>要求查询结果返回全部车信息</strong></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0, </span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "make": &#123;</span><br><span class="line">        "value": "honda"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ---------------------------------------</span></span><br><span class="line">  "post_filter": &#123;</span><br><span class="line">    "range": &#123;</span><br><span class="line">      "sold": &#123;</span><br><span class="line">        "from": "2014-07-01",</span><br><span class="line">        "to": "2014-12-31"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line"><span class="meta">  #</span><span class="bash"> ---------------------------------------</span></span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "average_price_of_cars_sold_in_2014_M6_to_M12": &#123;</span><br><span class="line">      "avg": &#123;</span><br><span class="line">        "field": "price"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="多桶排序-order"><a href="#多桶排序-order" class="headerlink" title="多桶排序: order"></a>多桶排序: order</h2><p>默认情况下，桶会根据<code>doc_count</code>降序排序，可以通过不同的处理方式修改桶的排序方式</p>
<h3 id="内置排序-count-term-key"><a href="#内置排序-count-term-key" class="headerlink" title="内置排序: _count, _term, _key"></a>内置排序: _count, _term, _key</h3><p>在聚合对象中引入<code>order</code>对象，可根据以下几个值进行排序</p>
<ul>
<li><code>_count</code>: 按文档排序，对<code>terms</code>, <code>histogram</code>, <code>date_histogram</code>有效；</li>
<li><code>_term</code>: 按词项的字符串值的字母排序，只对<code>terms</code>有效；</li>
<li><code>_key</code>: 按桶的键值数值排序，理论上与<code>_term</code>类似，只对<code>histogram</code>, <code>date_histogram</code>有效</li>
</ul>
<p>例如，按车的颜色进行分桶，各桶按文档数升序排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "colors_of_cars": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword",</span><br><span class="line">        # ------------------</span><br><span class="line">        "order": &#123;</span><br><span class="line">          "_term": "asc"</span><br><span class="line">        &#125;</span><br><span class="line">        # ------------------</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="按度量排序-自定义嵌套度量"><a href="#按度量排序-自定义嵌套度量" class="headerlink" title="按度量排序:自定义嵌套度量"></a>按度量排序:自定义嵌套度量</h3><p>可在<code>order</code>中传入自定义度量，该度量在聚合内定义，用<code>aggs.metric</code>进行访问</p>
<p>例如，<strong>按车的颜色进行分桶</strong>，各桶按价格的均值升序排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "colors_of_cars": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "color.keyword",</span><br><span class="line">        # -----------------------------</span><br><span class="line">        "order": &#123;</span><br><span class="line">          "stats_of_cars_in_this_color.variance": "asc"</span><br><span class="line">        &#125;</span><br><span class="line">        # -----------------------------</span><br><span class="line">      &#125;,</span><br><span class="line">      # -------------------------------</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "stats_of_cars_in_this_color": &#123;</span><br><span class="line">          "extended_stats": &#123;</span><br><span class="line">            "field": "price"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      # -------------------------------</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="“深度”度量排序-自定义嵌套更深的度量"><a href="#“深度”度量排序-自定义嵌套更深的度量" class="headerlink" title="“深度”度量排序:自定义嵌套更深的度量"></a>“深度”度量排序:自定义嵌套更深的度量</h3><p>在子聚合中定义孙聚合，用孙聚合的指标作为排序度量，用<code>aggs&gt;aggs.metric</code>访问，可定义更深的路径</p>
<p>例如，<strong>按价格分桶</strong>后，以各价格区间内<strong>红色、绿色车</strong>的<strong>价格方差降序</strong>排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "histogram_of_price": &#123;</span><br><span class="line">      "histogram": &#123;</span><br><span class="line">        "field": "price",</span><br><span class="line">        "interval": 5000,</span><br><span class="line">        # -----------------------------------</span><br><span class="line">        "order": &#123;</span><br><span class="line">          "red_green_cars&gt;price_stats.variance": "desc"</span><br><span class="line">        &#125;</span><br><span class="line">        # -----------------------------------</span><br><span class="line">      &#125;,</span><br><span class="line">      # -------------------------------------</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "red_green_cars": &#123;</span><br><span class="line">          "filter": &#123;</span><br><span class="line">            "terms": &#123;</span><br><span class="line">              "color": [</span><br><span class="line">                "red","green"</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          # ---------------------------------</span><br><span class="line">          "aggs": &#123;</span><br><span class="line">            "price_stats": &#123;</span><br><span class="line">              "extended_stats": &#123;</span><br><span class="line">                "field": "price"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="近似聚合"><a href="#近似聚合" class="headerlink" title="近似聚合"></a>近似聚合</h2><h3 id="统计去重后的数目-cardinality"><a href="#统计去重后的数目-cardinality" class="headerlink" title="统计去重后的数目: cardinality"></a>统计去重后的数目: cardinality</h3><p><code>cardinality</code>聚合可以确定某字段的值去重后的个数，例如：统计所有车颜色的种类个数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    # ---------------------------</span><br><span class="line">    "distinct_colors": &#123;</span><br><span class="line">      "cardinality": &#123;</span><br><span class="line">        "field": "color.keyword"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    # ---------------------------</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line"></span><br><span class="line">  "aggregations" : &#123;</span><br><span class="line">    "distinct_colors" : &#123;</span><br><span class="line">      "value" : 3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置精度-precision-threshold"><a href="#设置精度-precision-threshold" class="headerlink" title="设置精度: precision_threshold"></a>设置精度: precision_threshold</h4><p>指定参数<code>precision_threshold</code>，定义在何种基数水平下我们希望得到一个近乎精确的结果，例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "distinct_colors": &#123;</span><br><span class="line">      "cardinality": &#123;</span><br><span class="line">        "field": "color.keyword",</span><br><span class="line">        # ---------------------------</span><br><span class="line">        "precision_threshold": 100</span><br><span class="line">        # ---------------------------</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="优化速度-hash"><a href="#优化速度-hash" class="headerlink" title="优化速度: hash"></a>优化速度: hash</h4><p>在<code>mappings</code>中将<code>property.fields.hash</code>设置为<code>murmur3</code>类型，预先计算而不是在统计时计算哈希值<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DELETE /cars/</span><br><span class="line"></span><br><span class="line">PUT /cars/</span><br><span class="line">&#123;</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "transactions": &#123;</span><br><span class="line">      "properties": &#123;</span><br><span class="line">        "color": &#123;</span><br><span class="line">          "type": "string",</span><br><span class="line">          "fields": &#123;</span><br><span class="line">            "hash": &#123;</span><br><span class="line">              "type": "murmur3" </span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /cars/transactions/_bulk</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 10000, "color" : "red", "make" : "honda", "sold" : "2014-10-28" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 20000, "color" : "red", "make" : "honda", "sold" : "2014-11-05" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 30000, "color" : "green", "make" : "ford", "sold" : "2014-05-18" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 15000, "color" : "blue", "make" : "toyota", "sold" : "2014-07-02" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 12000, "color" : "green", "make" : "toyota", "sold" : "2014-08-19" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 20000, "color" : "red", "make" : "honda", "sold" : "2014-11-05" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 80000, "color" : "red", "make" : "bmw", "sold" : "2014-01-01" &#125;</span><br><span class="line">&#123; "index": &#123;&#125;&#125;</span><br><span class="line">&#123; "price" : 25000, "color" : "blue", "make" : "ford", "sold" : "2014-02-12" &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">    "size" : 0,</span><br><span class="line">    "aggs" : &#123;</span><br><span class="line">        "distinct_colors" : &#123;</span><br><span class="line">            "cardinality" : &#123;</span><br><span class="line">              "field" : "color.hash" </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="百分位数度量-percentiles"><a href="#百分位数度量-percentiles" class="headerlink" title="百分位数度量: percentiles"></a><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/percentiles.html" target="_blank" rel="noopener">百分位数度量: percentiles</a></h3><p>展现以具体百分比下观察到的数值，如第95各百分位上的数值，是高于95%的数据总和。常用于寻找异常数据，如应用于$3\sigma$准则</p>
<p>例如求各车价格的百分位数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "percentile": &#123;</span><br><span class="line">      "percentiles": &#123;</span><br><span class="line">        "field": "price",</span><br><span class="line">        "percents": [</span><br><span class="line">          1, 5, 25, 50, 75, 95, 99</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="elasticsearch-py"><a href="#elasticsearch-py" class="headerlink" title="elasticsearch-py"></a>elasticsearch-py</h1><blockquote>
<p><a href="https://elasticsearch-py.readthedocs.io/en/master/#" target="_blank" rel="noopener">Docs » Python Elasticsearch Client - Elasticsearch</a></p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># See more at https://elasticsearch-py.readthedocs.io/en/master/api.html#elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一些数据</span></span><br><span class="line">INDEX, TYPE = <span class="string">"cars"</span>, <span class="string">"transactions"</span></span><br><span class="line">TABLE = [</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">10000</span>, <span class="string">"color"</span> : <span class="string">"red"</span>, <span class="string">"make"</span> : <span class="string">"honda"</span>, <span class="string">"sold"</span> : <span class="string">"2014-10-28"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">20000</span>, <span class="string">"color"</span> : <span class="string">"red"</span>, <span class="string">"make"</span> : <span class="string">"honda"</span>, <span class="string">"sold"</span> : <span class="string">"2014-11-05"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">30000</span>, <span class="string">"color"</span> : <span class="string">"green"</span>, <span class="string">"make"</span> : <span class="string">"ford"</span>, <span class="string">"sold"</span> : <span class="string">"2014-05-18"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">15000</span>, <span class="string">"color"</span> : <span class="string">"blue"</span>, <span class="string">"make"</span> : <span class="string">"toyota"</span>, <span class="string">"sold"</span> : <span class="string">"2014-07-02"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">12000</span>, <span class="string">"color"</span> : <span class="string">"green"</span>, <span class="string">"make"</span> : <span class="string">"toyota"</span>, <span class="string">"sold"</span> : <span class="string">"2014-08-19"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">20000</span>, <span class="string">"color"</span> : <span class="string">"red"</span>, <span class="string">"make"</span> : <span class="string">"honda"</span>, <span class="string">"sold"</span> : <span class="string">"2014-11-05"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">80000</span>, <span class="string">"color"</span> : <span class="string">"red"</span>, <span class="string">"make"</span> : <span class="string">"bmw"</span>, <span class="string">"sold"</span> : <span class="string">"2014-01-01"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"price"</span> : <span class="number">25000</span>, <span class="string">"color"</span> : <span class="string">"blue"</span>, <span class="string">"make"</span> : <span class="string">"ford"</span>, <span class="string">"sold"</span> : <span class="string">"2014-02-12"</span> &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建ES对象</span></span><br><span class="line"><span class="keyword">from</span> elasticsearch6 <span class="keyword">import</span> Elasticsearch</span><br><span class="line">es = Elasticsearch([<span class="string">"localhost:9200"</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单条记录插入</span></span><br><span class="line">es.index(index=INDEX, doc_type=TYPE, id=<span class="string">"0"</span>, body=TABLE[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文档查找</span></span><br><span class="line">es.get(index=INDEX, doc_type=TYPE, id=<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文档更新</span></span><br><span class="line">body = &#123;</span><br><span class="line">    <span class="string">"doc"</span>:&#123;</span><br><span class="line">        <span class="string">"price"</span>: <span class="number">15000</span>,</span><br><span class="line">        <span class="string">"color"</span>: <span class="string">"green"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">es.update(index=INDEX, doc_type=TYPE, id=<span class="string">"0"</span>, body=body)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单条记录删除</span></span><br><span class="line">es.delete(index=INDEX, doc_type=TYPE, id=<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引批量数据，注意bulk输入格式</span></span><br><span class="line">body = []</span><br><span class="line"><span class="keyword">for</span> i, doc <span class="keyword">in</span> enumerate(TABLE):</span><br><span class="line">    option = &#123;</span><br><span class="line">        <span class="string">"index"</span>: &#123;</span><br><span class="line">            <span class="string">"_index"</span>: INDEX, <span class="string">"_type"</span>: TYPE, <span class="string">"_id"</span>: str(i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    body += [option, doc]</span><br><span class="line">print(body)</span><br><span class="line">es.bulk(index=INDEX, doc_type=TYPE, body=body)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询，例如：</span></span><br><span class="line"><span class="comment"># 查找所有红色车中，车辆价格在15000以上，下半年售出的车最佳</span></span><br><span class="line">body = &#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">      <span class="string">"must"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"term"</span>: &#123;</span><br><span class="line">            <span class="string">"color"</span>: &#123;</span><br><span class="line">              <span class="string">"value"</span>: <span class="string">"red"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"range"</span>: &#123;</span><br><span class="line">            <span class="string">"price"</span>: &#123;</span><br><span class="line">              <span class="string">"gte"</span>: <span class="number">15000</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"range"</span>: &#123;</span><br><span class="line">            <span class="string">"sold"</span>: &#123;</span><br><span class="line">              <span class="string">"from"</span>: <span class="string">"2014-07-01"</span>,</span><br><span class="line">              <span class="string">"to"</span>: <span class="string">"2014-12-31"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">es.search(index=INDEX, doc_type=TYPE, body=body)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 聚合，例如：</span></span><br><span class="line"><span class="comment"># 按颜色分桶，计算每种颜色平均价格，统计每种颜色的制造厂商及其各颜色售价的最大、最小值</span></span><br><span class="line">body = &#123;</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">"aggs"</span>: &#123;</span><br><span class="line">    <span class="string">"popular_colors"</span>: &#123;</span><br><span class="line">      <span class="string">"terms"</span>: &#123;</span><br><span class="line">        <span class="string">"field"</span>: <span class="string">"color.keyword"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"aggs"</span>: &#123;</span><br><span class="line">        <span class="string">"average_price_of_color"</span>: &#123;</span><br><span class="line">          <span class="string">"avg"</span>: &#123;</span><br><span class="line">            <span class="string">"field"</span>: <span class="string">"price"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"the_maker_of_the_car_of_this_color"</span>: &#123;</span><br><span class="line">          <span class="string">"terms"</span>: &#123;</span><br><span class="line">            <span class="string">"field"</span>: <span class="string">"make.keyword"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"aggs"</span>: &#123;</span><br><span class="line">            <span class="string">"minimal_price_of_this_color_of_this_maker"</span>: &#123;</span><br><span class="line">              <span class="string">"min"</span>: &#123;</span><br><span class="line">                <span class="string">"field"</span>: <span class="string">"price"</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"maximal_price_of_this_color_of_this_maker"</span>: &#123;</span><br><span class="line">              <span class="string">"max"</span>: &#123;</span><br><span class="line">                <span class="string">"field"</span>: <span class="string">"price"</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">es.search(index=INDEX, doc_type=TYPE, body=body)</span><br></pre></td></tr></table></figure>
<!-- # 使用案例

> [Kibana 用户手册 » 基础入门 » 加载示例数据](https://www.elastic.co/guide/cn/kibana/current/tutorial-load-dataset.html)

以[shakespeare.json](https://download.elastic.co/demos/kibana/gettingstarted/shakespeare_6.0.json)为数据，对其进行索引、查询等操作，各文档数据组织方式为
``` json
{
    "line_id": INT,
    "play_name": "String",
    "speech_number": INT,
    "line_number": "String",
    "speaker": "String",
    "text_entry": "String",
}
``` -->

      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Louis Hsu 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/大数据/" rel="tag"># 大数据</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/08/MySQL/" rel="next" title="MySQL">
                <i class="fa fa-chevron-left"></i> MySQL
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Louis Hsu">
            
              <p class="site-author-name" itemprop="name">Louis Hsu</p>
              <p class="site-description motion-element" itemprop="description">技术博客？</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">97</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/isLouisHsu" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://is.louishsu@foxmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/islouishsu" target="_blank" title="Zhihu"><i class="fa fa-fw fa-zhihu"></i>Zhihu</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/islouishsu" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          <div id="music163player">
            <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="110" src="//music.163.com/outchain/player?type=0&id=2703291040&auto=1&height=90">
            </iframe>
          </div>

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目录"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基础入门"><span class="nav-number">2.</span> <span class="nav-text">基础入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装运行"><span class="nav-number">2.1.</span> <span class="nav-text">安装运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#特性"><span class="nav-number">2.2.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#交互语句"><span class="nav-number">2.3.</span> <span class="nav-text">交互语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据操作"><span class="nav-number">2.4.</span> <span class="nav-text">数据操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#元数据"><span class="nav-number">2.4.1.</span> <span class="nav-text">元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查文档-HEAD"><span class="nav-number">2.4.2.</span> <span class="nav-text">检查文档: HEAD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引文档-PUT或POST"><span class="nav-number">2.4.3.</span> <span class="nav-text">索引文档: PUT或POST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建文档-PUT-URL-creat或POST"><span class="nav-number">2.4.4.</span> <span class="nav-text">新建文档: PUT /URL/_creat或POST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新文档-PUT"><span class="nav-number">2.4.5.</span> <span class="nav-text">更新文档: PUT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部分更新-POST-URL-update"><span class="nav-number">2.4.6.</span> <span class="nav-text">部分更新: POST /URL/_update</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取回文档-GET"><span class="nav-number">2.4.7.</span> <span class="nav-text">取回文档: GET</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取回多个文档-GET-mget"><span class="nav-number">2.4.8.</span> <span class="nav-text">取回多个文档: GET /_mget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除文档-DELETE"><span class="nav-number">2.4.9.</span> <span class="nav-text">删除文档: DELETE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#批量操作-POST-bulk"><span class="nav-number">2.4.10.</span> <span class="nav-text">批量操作: POST /_bulk</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搜索-可用请求体查询替代"><span class="nav-number">2.5.</span> <span class="nav-text">搜索(可用请求体查询替代)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#空搜索"><span class="nav-number">2.5.1.</span> <span class="nav-text">空搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多索引和多类型"><span class="nav-number">2.5.2.</span> <span class="nav-text">多索引和多类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定查询搜索"><span class="nav-number">2.5.3.</span> <span class="nav-text">指定查询搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结果分页"><span class="nav-number">2.5.4.</span> <span class="nav-text">结果分页</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#映射与分析"><span class="nav-number">2.6.</span> <span class="nav-text">映射与分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#映射"><span class="nav-number">2.6.1.</span> <span class="nav-text">映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单域类型"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">简单域类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看映射-GET-index-mapping"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">查看映射: GET /_index/_mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义映射"><span class="nav-number">2.6.1.3.</span> <span class="nav-text">自定义映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新映射-PUT-index-“mappings”-…"><span class="nav-number">2.6.1.4.</span> <span class="nav-text">更新映射: PUT /_index {“mappings”: {…} }</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试映射-GET-index-analyze"><span class="nav-number">2.6.1.5.</span> <span class="nav-text">测试映射: GET /_index/_analyze</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分析"><span class="nav-number">2.6.2.</span> <span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求体查询-GET-URL-search-“query”-…"><span class="nav-number">2.7.</span> <span class="nav-text">请求体查询: GET /URL/_search {“query”: {…} }</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#几个重要的查询"><span class="nav-number">2.7.1.</span> <span class="nav-text">几个重要的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#match-all"><span class="nav-number">2.7.1.1.</span> <span class="nav-text">match_all</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#match-multi-match"><span class="nav-number">2.7.1.2.</span> <span class="nav-text">match/multi_match</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#term-terms"><span class="nav-number">2.7.1.3.</span> <span class="nav-text">term/terms</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exists"><span class="nav-number">2.7.1.4.</span> <span class="nav-text">exists</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#range"><span class="nav-number">2.7.1.5.</span> <span class="nav-text">range</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组合多个查询"><span class="nav-number">2.7.2.</span> <span class="nav-text">组合多个查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#must"><span class="nav-number">2.7.2.1.</span> <span class="nav-text">must</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#must-not"><span class="nav-number">2.7.2.2.</span> <span class="nav-text">must_not</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#should"><span class="nav-number">2.7.2.3.</span> <span class="nav-text">should</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filter"><span class="nav-number">2.7.2.4.</span> <span class="nav-text">filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bool"><span class="nav-number">2.7.2.5.</span> <span class="nav-text">bool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#constant-score"><span class="nav-number">2.7.2.6.</span> <span class="nav-text">constant_score</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证查询-GET-URL-search-validate-query-explain"><span class="nav-number">2.7.3.</span> <span class="nav-text">验证查询: GET /URL/_search/_validate/query?explain</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#排序与相关性"><span class="nav-number">2.8.</span> <span class="nav-text">排序与相关性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#排序-GET-URL-search-“sort”-…"><span class="nav-number">2.8.1.</span> <span class="nav-text">排序: GET /URL/_search { “sort”: { … } }</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#按字段值排序"><span class="nav-number">2.8.1.1.</span> <span class="nav-text">按字段值排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多级排序"><span class="nav-number">2.8.1.2.</span> <span class="nav-text">多级排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多值字段排序"><span class="nav-number">2.8.1.3.</span> <span class="nav-text">多值字段排序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关性-score"><span class="nav-number">2.8.2.</span> <span class="nav-text">相关性: _score</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引管理"><span class="nav-number">2.9.</span> <span class="nav-text">索引管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-PUT-index"><span class="nav-number">2.9.1.</span> <span class="nav-text">创建: PUT /_index</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#settings"><span class="nav-number">2.9.1.1.</span> <span class="nav-text">settings</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#number-of-shards-number-of-replicas"><span class="nav-number">2.9.1.1.1.</span> <span class="nav-text">number_of_shards/number_of_replicas</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#analysis"><span class="nav-number">2.9.1.1.2.</span> <span class="nav-text">analysis</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mappings"><span class="nav-number">2.9.1.2.</span> <span class="nav-text">mappings</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除-DELETE-index"><span class="nav-number">2.9.2.</span> <span class="nav-text">删除: DELETE /_index</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#深入搜索"><span class="nav-number">3.</span> <span class="nav-text">深入搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#结构化搜索"><span class="nav-number">3.1.</span> <span class="nav-text">结构化搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#精确值查找-term"><span class="nav-number">3.1.1.</span> <span class="nav-text">精确值查找: term</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组合过滤器-bool"><span class="nav-number">3.1.2.</span> <span class="nav-text">组合过滤器: bool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#精确查找多个值-terms"><span class="nav-number">3.1.3.</span> <span class="nav-text">精确查找多个值: terms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#范围-range"><span class="nav-number">3.1.4.</span> <span class="nav-text">范围: range</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理空值-exists"><span class="nav-number">3.1.5.</span> <span class="nav-text">处理空值: exists</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#全文搜索"><span class="nav-number">3.2.</span> <span class="nav-text">全文搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#匹配查询-match"><span class="nav-number">3.2.1.</span> <span class="nav-text">匹配查询: match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多词查询-match"><span class="nav-number">3.2.2.</span> <span class="nav-text">多词查询: match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组合查询-bool"><span class="nav-number">3.2.3.</span> <span class="nav-text">组合查询: bool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#语句权重-boost"><span class="nav-number">3.2.4.</span> <span class="nav-text">语句权重: boost</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制分析-GET-URL-index-analyze-“field”-…-“text”-…"><span class="nav-number">3.2.5.</span> <span class="nav-text">控制分析: GET /URL/_index/_analyze { “field”: …, “text”: … }</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多字段查询"><span class="nav-number">3.3.</span> <span class="nav-text">多字段查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多字段查询-multi-match"><span class="nav-number">3.3.1.</span> <span class="nav-text">多字段查询: multi_match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最佳字段-best-fields-dis-max"><span class="nav-number">3.3.2.</span> <span class="nav-text">最佳字段(best_fields): dis_max</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多数字段-most-fields-field-subField"><span class="nav-number">3.3.3.</span> <span class="nav-text">多数字段(most_fields): field.subField</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨字段-cross-fields-filed1-…-filedn"><span class="nav-number">3.3.4.</span> <span class="nav-text">跨字段(cross_fields): filed1, …, filedn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#all字段-copy-to"><span class="nav-number">3.3.5.</span> <span class="nav-text">_all字段: copy_to</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#近似匹配"><span class="nav-number">3.4.</span> <span class="nav-text">近似匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#短语匹配-match-phrase"><span class="nav-number">3.4.1.</span> <span class="nav-text">短语匹配: match_phrase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结果集重新评分-rescore"><span class="nav-number">3.4.2.</span> <span class="nav-text">结果集重新评分: rescore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关词-shingles-Ngrams"><span class="nav-number">3.4.3.</span> <span class="nav-text">相关词: shingles/Ngrams</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部分匹配"><span class="nav-number">3.5.</span> <span class="nav-text">部分匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前缀查询-prefix"><span class="nav-number">3.5.1.</span> <span class="nav-text">前缀查询: prefix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前缀短语匹配-match-phrase-prefix"><span class="nav-number">3.5.2.</span> <span class="nav-text">前缀短语匹配: match_phrase_prefix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通配符查询-wildcard"><span class="nav-number">3.5.3.</span> <span class="nav-text">通配符查询: wildcard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正则表达式查询-regexp"><span class="nav-number">3.5.4.</span> <span class="nav-text">正则表达式查询: regexp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制相关度"><span class="nav-number">3.6.</span> <span class="nav-text">控制相关度</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#聚合"><span class="nav-number">4.</span> <span class="nav-text">聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#尝试聚合"><span class="nav-number">4.1.</span> <span class="nav-text">尝试聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#命令格式-GET-URL-search-“aggs”-“NAME”-AGG-TYPE-…"><span class="nav-number">4.1.1.</span> <span class="nav-text">命令格式: GET /URL/_search { “aggs”: { “NAME”: { AGG_TYPE: { … } } } }</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单例子-terms-avg-max-min"><span class="nav-number">4.1.2.</span> <span class="nav-text">简单例子: terms, avg, max, min</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限定聚合范围-query-global"><span class="nav-number">4.2.</span> <span class="nav-text">限定聚合范围: query, global</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#直方图统计-histogram"><span class="nav-number">4.3.</span> <span class="nav-text">直方图统计: histogram</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#统计量计算-extended-stats"><span class="nav-number">4.4.</span> <span class="nav-text">统计量计算: extended_stats</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#按时间统计-date-histogram"><span class="nav-number">4.5.</span> <span class="nav-text">按时间统计: date_histogram</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过滤和聚合"><span class="nav-number">4.6.</span> <span class="nav-text">过滤和聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询过滤-“query”-…-“filter”-…"><span class="nav-number">4.6.1.</span> <span class="nav-text">查询过滤: “query”: { …, “filter”, … }</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#聚合过滤-“aggs”-…-“filter”-…"><span class="nav-number">4.6.2.</span> <span class="nav-text">聚合过滤: “aggs”: { …, “filter”, … }</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后过滤器-post-filter"><span class="nav-number">4.6.3.</span> <span class="nav-text">后过滤器: post_filter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多桶排序-order"><span class="nav-number">4.7.</span> <span class="nav-text">多桶排序: order</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#内置排序-count-term-key"><span class="nav-number">4.7.1.</span> <span class="nav-text">内置排序: _count, _term, _key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#按度量排序-自定义嵌套度量"><span class="nav-number">4.7.2.</span> <span class="nav-text">按度量排序:自定义嵌套度量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“深度”度量排序-自定义嵌套更深的度量"><span class="nav-number">4.7.3.</span> <span class="nav-text">“深度”度量排序:自定义嵌套更深的度量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#近似聚合"><span class="nav-number">4.8.</span> <span class="nav-text">近似聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#统计去重后的数目-cardinality"><span class="nav-number">4.8.1.</span> <span class="nav-text">统计去重后的数目: cardinality</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设置精度-precision-threshold"><span class="nav-number">4.8.1.1.</span> <span class="nav-text">设置精度: precision_threshold</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优化速度-hash"><span class="nav-number">4.8.1.2.</span> <span class="nav-text">优化速度: hash</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#百分位数度量-percentiles"><span class="nav-number">4.8.2.</span> <span class="nav-text">百分位数度量: percentiles</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#elasticsearch-py"><span class="nav-number">5.</span> <span class="nav-text">elasticsearch-py</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Louis Hsu</span>

  

  
</div>











        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  



  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  



  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'e65d27f7cf5c62feaf97',
          clientSecret: '356386826698e8b817ca076b08d7c0e9814f52ea',
          repo: 'isLouisHsu.github.io',
          owner: 'isLouisHsu',
          admin: ['isLouisHsu'],
          id: md5(window.location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')
       </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('3');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>



  <script type="text/javascript" src="/js/click_show_text.js"></script>
  <script type="text/javascript" src="/js/hone_hone_clock.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
