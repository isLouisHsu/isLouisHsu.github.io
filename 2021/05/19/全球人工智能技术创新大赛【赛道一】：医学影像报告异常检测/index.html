<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.2',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="目录 目录 赛题介绍 赛题背景 赛题描述 赛题数据 提交要求 评估标准   赛题思路   数据处理 探索分析 数据划分 样本重加权 数据增强   模型训练 模型结构 预训练 微调   模型集成 方案优化 大赛结果 Top方案 不足与展望 参考文献 附录 半监督学习 Blending    赛题介绍赛题背景&amp;emsp; &amp;emsp;影像科医生在工作时会观察医学影像（如CT、核磁共振影像），并对其作出">
<meta property="og:type" content="article">
<meta property="og:title" content="全球人工智能技术创新大赛【赛道一】：医学影像报告异常检测">
<meta property="og:url" content="http://yoursite.com/2021/05/19/%E5%85%A8%E7%90%83%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E5%A4%A7%E8%B5%9B%E3%80%90%E8%B5%9B%E9%81%93%E4%B8%80%E3%80%91%EF%BC%9A%E5%8C%BB%E5%AD%A6%E5%BD%B1%E5%83%8F%E6%8A%A5%E5%91%8A%E5%BC%82%E5%B8%B8%E6%A3%80%E6%B5%8B/index.html">
<meta property="og:site_name" content="LOUIS&#39; BLOG">
<meta property="og:description" content="目录 目录 赛题介绍 赛题背景 赛题描述 赛题数据 提交要求 评估标准   赛题思路   数据处理 探索分析 数据划分 样本重加权 数据增强   模型训练 模型结构 预训练 微调   模型集成 方案优化 大赛结果 Top方案 不足与展望 参考文献 附录 半监督学习 Blending    赛题介绍赛题背景&amp;emsp; &amp;emsp;影像科医生在工作时会观察医学影像（如CT、核磁共振影像），并对其作出">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite/Fig1_pretrain_finetune.png">
<meta property="og:image" content="http://yoursite/Fig2_eda1.png">
<meta property="og:image" content="http://yoursite/Fig2_eda2.png">
<meta property="og:image" content="http://yoursite/Fig2_eda3.png">
<meta property="og:image" content="http://yoursite/Fig3_reweight.png">
<meta property="og:image" content="http://yoursite/Fig5_model1.png">
<meta property="og:image" content="http://yoursite/Fig5_attention_mask.png">
<meta property="og:image" content="http://yoursite/Fig4_wwm.png">
<meta property="og:image" content="http://yoursite/Fig5_model2.png">
<meta property="og:image" content="http://yoursite/Fig5_model3.png">
<meta property="og:image" content="http://yoursite/Fig7_ensemble1.png">
<meta property="og:image" content="http://yoursite/Fig6_res1.png">
<meta property="og:image" content="http://yoursite/Fig6_res2.png">
<meta property="article:published_time" content="2021-05-19T09:57:06.000Z">
<meta property="article:modified_time" content="2021-05-21T04:14:58.766Z">
<meta property="article:author" content="Louis Hsu">
<meta property="article:tag" content="Competition">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite/Fig1_pretrain_finetune.png">






  <link rel="canonical" href="http://yoursite.com/2021/05/19/全球人工智能技术创新大赛【赛道一】：医学影像报告异常检测/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>全球人工智能技术创新大赛【赛道一】：医学影像报告异常检测 | LOUIS' BLOG</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LOUIS' BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">To be better</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-guestbook">
    <a href="/guestbook" rel="section">
      <i class="menu-item-icon fa fa-fw fa-guest"></i> <br />留言</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
    
      
    
    <a href="https://github.com/isLouisHsu" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
    
      </a>
    



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/19/%E5%85%A8%E7%90%83%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E5%A4%A7%E8%B5%9B%E3%80%90%E8%B5%9B%E9%81%93%E4%B8%80%E3%80%91%EF%BC%9A%E5%8C%BB%E5%AD%A6%E5%BD%B1%E5%83%8F%E6%8A%A5%E5%91%8A%E5%BC%82%E5%B8%B8%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Louis Hsu">
      <meta itemprop="description" content="ᵕ᷄ ≀ ̠˘᷅ 永远年轻，永远热泪盈眶">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LOUIS' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">全球人工智能技术创新大赛【赛道一】：医学影像报告异常检测
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-05-19 17:57:06" itemprop="dateCreated datePublished" datetime="2021-05-19T17:57:06+08:00">2021-05-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-05-21 12:14:58" itemprop="dateModified" datetime="2021-05-21T12:14:58+08:00">2021-05-21</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#目录">目录</a></li>
<li><a href="#赛题介绍">赛题介绍</a><ul>
<li><a href="#赛题背景">赛题背景</a></li>
<li><a href="#赛题描述">赛题描述</a><ul>
<li><a href="#赛题数据">赛题数据</a></li>
<li><a href="#提交要求">提交要求</a></li>
<li><a href="#评估标准">评估标准</a></li>
</ul>
</li>
<li><a href="#赛题思路">赛题思路</a></li>
</ul>
</li>
<li><a href="#数据处理">数据处理</a><ul>
<li><a href="#探索分析">探索分析</a></li>
<li><a href="#数据划分">数据划分</a></li>
<li><a href="#样本重加权">样本重加权</a></li>
<li><a href="#数据增强">数据增强</a></li>
</ul>
</li>
<li><a href="#模型训练">模型训练</a><ul>
<li><a href="#模型结构">模型结构</a></li>
<li><a href="#预训练">预训练</a></li>
<li><a href="#微调">微调</a></li>
</ul>
</li>
<li><a href="#模型集成">模型集成</a></li>
<li><a href="#方案优化">方案优化</a></li>
<li><a href="#大赛结果">大赛结果</a></li>
<li><a href="#top方案">Top方案</a></li>
<li><a href="#不足与展望">不足与展望</a></li>
<li><a href="#参考文献">参考文献</a></li>
<li><a href="#附录">附录</a><ul>
<li><a href="#半监督学习">半监督学习</a></li>
<li><a href="#blending">Blending</a></li>
</ul>
</li>
</ul>
<h1 id="赛题介绍"><a href="#赛题介绍" class="headerlink" title="赛题介绍"></a>赛题介绍</h1><h2 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h2><p>&emsp; &emsp;影像科医生在工作时会观察医学影像（如CT、核磁共振影像），并对其作出描述，这些描述中包含了大量医学信息，对医疗AI具有重要意义。<strong>本任务需要参赛队伍根据医生对CT的影像描述文本数据，判断身体若干目标区域是否有异常以及异常的类型</strong>。初赛阶段仅需判断各区域是否有异常，复赛阶段除了判断有异常的区域外，还需判断异常的类型。判断的结果按照指定评价指标进行评测和排名，得分最优者获胜。</p>
<blockquote>
<p>赛题链接：<a href="https://tianchi.aliyun.com/competition/entrance/531852/introduction?spm=5176.12281957.1004.9.38b03eaf8ds5LL" target="_blank" rel="noopener">Link</a></p>
</blockquote>
<h2 id="赛题描述"><a href="#赛题描述" class="headerlink" title="赛题描述"></a>赛题描述</h2><h3 id="赛题数据"><a href="#赛题数据" class="headerlink" title="赛题数据"></a>赛题数据</h3><p>大赛分为初赛A/B榜、复赛A/B榜以及决赛答辩，各时间点公布的数据文件及时间如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>数据文件</th>
<th>发布时间</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>track1_round1_train_20210222.csv</td>
<td>2021.03.02(初赛A榜)</td>
<td>仅包含区域标注</td>
</tr>
<tr>
<td>track1_round1_testA_20210222.csv</td>
<td>2021.03.02(初赛A榜)</td>
<td>测试集数据，无标注</td>
</tr>
<tr>
<td>track1_round1_testB.csv</td>
<td>2021.04.08(初赛B榜)</td>
<td>测试集数据，无标注</td>
</tr>
<tr>
<td>train.csv</td>
<td>2021.04.15(复赛A榜)</td>
<td>包含区域与类型标注</td>
</tr>
<tr>
<td>testA.csv</td>
<td>2021.04.15(复赛A榜)</td>
<td>测试集数据，无标注，不开放下载</td>
</tr>
<tr>
<td>testB.csv</td>
<td>2021.05.08(复赛B榜)</td>
<td>测试集数据，无标注，不开放下载</td>
</tr>
</tbody>
</table>
</div>
<p>初赛训练数据格式如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>report_ID</td>
<td>数据标号，整型</td>
<td>1</td>
</tr>
<tr>
<td>description</td>
<td>脱敏后的影像描述，以字为单位使用空格分割</td>
<td>101 47 12 66 74 90 0 411 234 79 175</td>
</tr>
<tr>
<td>label</td>
<td>由多个异常区域ID组成，以空格分隔。若此描述中无异常区域，则为空</td>
<td>3 4</td>
</tr>
</tbody>
</table>
</div>
<p>复赛训练数据格式如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>report_ID</td>
<td>数据标号，整型</td>
<td>1</td>
</tr>
<tr>
<td>description</td>
<td>脱敏后的影像描述，以字为单位使用空格分割</td>
<td>101 47 12 66 74 90 0 411 234 79 175</td>
</tr>
<tr>
<td>label</td>
<td>string，由两部分组成。第一部分为若干异常区域ID，用空格分割。第二部分为若干异常类型ID，用空格分割。两部分用逗号“,”分割。若定义中所有区域均无异常，则两部分均为空，此项为“,”。</td>
<td>3 4,0 2</td>
</tr>
</tbody>
</table>
</div>
<p>测试集数据</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>report_ID</td>
<td>数据标号，整型</td>
<td>1</td>
</tr>
<tr>
<td>description</td>
<td>脱敏后的影像描述，以字为单位使用空格分割</td>
<td>101 47 12 66 74 90 0 411 234 79 175</td>
</tr>
</tbody>
</table>
</div>
<p>例如带有区域和类型标注的复赛训练集数据样例为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0|,|623 355 582 617 265 162 498 289 169 137 405 693 399 842 698 335 266 14 177 415 381 693 48 328 461 478 439 473 851 636 739 374 698 494 504 656 575 754 421 421 791 200 103 718 569 |,|,</span><br><span class="line">1|,|623 328 328 380 172 54 823 487 391 693 256 433 569 231 171 852 770 693 48 328 305 461 406 333 399 698 177 415 14 381 |,|,</span><br><span class="line">2|,|708 328 328 380 172 470 455 693 256 514 569 231 113 256 693 852 328 328 380 172 300 320 842 698 149 338 266 521 415 381 693 700 830 273 332 |,|15 ,2 </span><br><span class="line">3|,|48 697 91 399 28 400 478 809 623 697 538 265 478 284 498 289 399 698 335 266 477 300 381 693 38 582 623 697 382 382 363 397 455 |,|0 7 ,9 </span><br><span class="line">4|,|411 657 399 698 17 36 575 548 435 142 51 519 421 569 183 693 380 136 363 556 698 432 449 177 415 381 693 477 767 809 712 477 767 37 11 693 430 698 251 391 |,|15 ,11 </span><br><span class="line">5|,|852 261 669 105 259 160 362 341 639 693 747 750 399 842 837 161 372 14 177 415 693 623 328 411 204 399 842 698 160 338 177 415 832 14 381 |,|,</span><br><span class="line">6|,|852 328 355 382 610 538 382 382 327 543 381 |,|,</span><br><span class="line">7|,|8 266 627 93 333 832 47 693 380 598 200 737 470 290 693 380 834 809 342 809 257 654 832 47 693 852 328 566 357 659 439 697 582 162 498 289 169 405 |,|,</span><br><span class="line">8|,|443 380 172 56 180 345 693 380 809 343 218 654 832 47 402 690 693 256 696 569 233 306 256 |,|,</span><br><span class="line">9|,|623 328 554 232 461 204 399 842 698 177 832 14 381 |,|,</span><br><span class="line">10|,|328 697 538 678 355 661 698 335 338 408 521 86 415 693 240 221 104 328 328 380 172 12 187 394 174 506 37 788 313 66 832 429 |,|0 1 2 ,2</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h3 id="提交要求"><a href="#提交要求" class="headerlink" title="提交要求"></a>提交要求</h3><p>所需提交文件格式为</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>report_ID</td>
<td>数据标号，整型</td>
<td>1</td>
</tr>
<tr>
<td>Prediction</td>
<td>预测输出向量（初赛为17维，复赛为29维），以空格分割，值在0到1之间，表示区域/类型包含异常类型的概率</td>
<td>0.68 0.82 0.92 0.59 0.71 0.23 0.45 0.36 0.46 0.64 0.92 0.66 0.3 0.5 0.94 0.7 0.38 0.05 0.97 0.71 0.5 0.64 0.0 0.54 0.5 0.49 0.41 0.06 0.07</td>
</tr>
</tbody>
</table>
</div>
<h3 id="评估标准"><a href="#评估标准" class="headerlink" title="评估标准"></a>评估标准</h3><p>评估指标较为严格，以测试集数据上对提交结果计算的$\text{mlogloss}$指标为基础，两阶段计算有所区别：</p>
<ul>
<li><p><strong>初赛阶段</strong>：记样本个数为$N$，每个样本对应$M=17$个预测值，那么首先计算$M \times N$个预测值的均值如下</p>
<script type="math/tex; mode=display">
  \text{mlogloss}(y, \tilde{y}) = - 
      \frac{1}{M} \sum_{m=1}^M
      \frac{1}{N} \sum_{m=1}^N
      \left [
      y_{nm} \log \tilde{y}_{nm} + (1 - y_{nm}) \log (1 - \tilde{y}_{nm})
      \right] \tag{1}</script><p>  最终初赛评分为$S = 1 - \text{mlogloss}$。</p>
</li>
<li><p><strong>复赛阶段</strong>：为了让分数区间更合理，复赛阶段调整为$1 - 2 \times \text{mlogloss}$。另外，复赛阶段分数由两部分组成：</p>
<ul>
<li>第一部分（区域）得分$S_1$计算方式与初赛一致，对$N \times M_1$个预测值计算指标；</li>
<li>第二部分（类型）得分$S_2$对所有实际存在异常区域的测试样本计算$\text{mlogloss}$指标，例如$N$个样本中包含$K$个存在区域异常的样本，那么对$K \times M_2$个预测值计算$\text{mlogloss}$指标。</li>
</ul>
<p>最终复赛得分为$S = 0.6 \times S_1 + 0.4 \times S_2$。</p>
</li>
</ul>
<h2 id="赛题思路"><a href="#赛题思路" class="headerlink" title="赛题思路"></a>赛题思路</h2><ol>
<li>文本数据脱敏是该题一方面的限制，因为不能利用公开的预训练模型对应的词表，也就不能直接在公开模型基础上微调，需要<strong>重新生成词表并预训练</strong>；</li>
<li>该任务是一个典型的<strong>多标签分类任务</strong>，需要对每个标签进行异常判别，在微调阶段采用二分类交叉熵（BCE）损失，与评测指标一致。</li>
</ol>
<p><img src="//yoursite/Fig1_pretrain_finetune.png" alt="Fig1_pretrain_finetune"></p>
<h1 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h1><h2 id="探索分析"><a href="#探索分析" class="headerlink" title="探索分析"></a>探索分析</h2><p><img src="//yoursite/Fig2_eda1.png" alt="Fig2_eda1"><br><img src="//yoursite/Fig2_eda2.png" alt="Fig2_eda2"><br><img src="//yoursite/Fig2_eda3.png" alt="Fig2_eda3"></p>
<ul>
<li><strong>数据总数</strong>：初赛训练集共10000条，A/B榜分别有3000条；复赛训练集共20000条，A/B榜分别有5000条。</li>
<li><strong>文本长度</strong>：长度最小为2，最大长度都短于128。</li>
<li><strong>词表统计</strong>：词表大小为852，词频分布较为一致。</li>
<li><strong>标签统计</strong>：初赛和复赛在标签上的分布存在不一致。</li>
</ul>
<h2 id="数据划分"><a href="#数据划分" class="headerlink" title="数据划分"></a>数据划分</h2><p>数据划分的目的是：</p>
<ul>
<li>从训练集总体中划分一部分作为验证集(dev)，用作early-stopping；</li>
<li>模型使用不同划分的数据训练，能增大模型差异，为后续模型集成作准备。</li>
</ul>
<p>尝试使用多种数据划分方式，如</p>
<ul>
<li>多次随机划分(<code>sklearn.model_selection.ShuffleSplit</code>)；</li>
<li>普通K折划分(<code>sklearn.model_selection.KFold</code>)；</li>
<li>多标签分层K折采样(<code>iterstrat.ml_stratifiers.MultilabelStratifiedKFold</code>)；</li>
<li>对抗验证(adversarial validation)。</li>
</ul>
<blockquote>
<p>adversarial validation 详情参考：<a href="https://lonepatient.top/2018/07/10/Adversarial%20validation.html" target="_blank" rel="noopener">Link</a></p>
</blockquote>
<p>实验发现多标签分层K折采样训练得到的模型，在集成中收益最大，可能原因如下</p>
<ul>
<li>K折划分获得的多折训练集两两间都存在差异，可以增大模型差异，提升集成效果；</li>
<li>划分过程中，需尽量使训练集的数据分布尽可能与原始数据分布保持一致，分层(stratified)能使标签分布保持一致。</li>
</ul>
<p>考虑到以下几点，取$K=5$：</p>
<ul>
<li>K取值越大时，每折训练集中样本个数越多，模型训练次数也越多，导致训练时间过长；</li>
<li>会导致折间差异变小，影响模型融合效果。</li>
</ul>
<h2 id="样本重加权"><a href="#样本重加权" class="headerlink" title="样本重加权"></a>样本重加权</h2><p>&emsp; &emsp;本地验证集上能达到$0.96+$的分数，但实际LB的分数最高也只有$0.94$左右，因此线上线下存在较大的不一致。为了减少不一致，对训练集样本进行重加权，权值由TFIDF与余弦相似度评估，具体计算方法是：用给定文本语料训练TFIDF参数，然后计算训练集与测试集样本两两间的句级相似度，取均值得到各训练集样本权重，如下图所示。<br><img src="//yoursite/Fig3_reweight.png" alt="Fig3_reweight"></p>
<h2 id="数据增强"><a href="#数据增强" class="headerlink" title="数据增强"></a>数据增强</h2><p>&emsp; &emsp;受目前视觉领域Mixup、Cutout与CutMix数据增强方式<a href="#ref"><sup>[1]</sup></a>启发，本方案设计了与其类似的数据增强方式，具体方法为：从训练样本集中随机选择两个原始样本，随机打乱顺序后拼接得到扩增样本，并将两个原始样本的标签进行合并，具体如下，注意此时要调整模型的最大输入长度。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>样本</th>
<th>tokens</th>
<th>label</th>
</tr>
</thead>
<tbody>
<tr>
<td>原始样本1</td>
<td>708 328 328 380 172 470 455 693 256 514 569 231 113 256 693 852 328 328 380 172 300 320 842 698 149 338 266 521 415 381 693 700 830 273 332</td>
<td>15, 2</td>
</tr>
<tr>
<td>原始样本2</td>
<td>411 657 399 698 17 36 575 548 435 142 51 519 421 569 183 693 380 136 363 556 698 432 449 177 415 381 693 477 767 809 712 477 767 37 11 693 430 698 251 391</td>
<td>15, 11</td>
</tr>
<tr>
<td>扩增样本</td>
<td>708 328 328 380 172 470 455 693 256 514 569 231 113 256 693 852 328 328 380 172 300 320 842 698 149 338 266 521 415 381 693 700 830 273 332 411 657 399 698 17 36 575 548 435 142 51 519 421 569 183 693 380 136 363 556 698 432 449 177 415 381 693 477 767 809 712 477 767 37 11 693 430 698 251 391</td>
<td>2, 11, 15</td>
</tr>
</tbody>
</table>
</div>
<p>另外，尝试使用了EDA数据增强<a href="#ref"><sup>[2]</sup></a>，但效果欠佳</p>
<ul>
<li>同义词替换(Synonyms Replace, SR)：不考虑stopwords，在句子中随机抽取n个词，然后从同义词词典中随机抽取同义词，并进行替换。</li>
<li>随机插入(Randomly Insert, RI)：不考虑stopwords，随机抽取一个词，然后在该词的同义词集合中随机选择一个，插入原句子中的随机位置。该过程可以重复n次。</li>
<li>随机交换(Randomly Swap, RS)：句子中，随机选择两个词，位置交换。该过程可以重复n次。</li>
<li>随机删除(Randomly Delete, RD)：句子中的每个词，以概率p随机删除。</li>
</ul>
<h1 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h1><h2 id="模型结构"><a href="#模型结构" class="headerlink" title="模型结构"></a>模型结构</h2><p>&emsp; &emsp;目前，NLP领域的SOTA都是预训练加微调的方案，其中预训练模型(Pre-training Language Models, PLMs)是在大量语料上进行无监督训练得到的，网络结构采用Transformer模型(Encoder或Decoder)，常见的有：BERT<a href="#ref"><sup>[3]</sup></a>、RoBERTa<a href="#ref"><sup>[4]</sup></a>、XLNet<a href="#ref"><sup>[5]</sup></a>、GPT<a href="#ref"><sup>[6]</sup></a>、UniLM<a href="#ref"><sup>[7,8,9]</sup></a>等，国内相关技术如百度的ERNIE<a href="#ref"><sup>[10]</sup></a>、华为的NEZHA<a href="#ref"><sup>[11]</sup></a>等。本方案使用了两种预训练模型，分别是华为提出的NEZHA、苏剑林(苏神)提出的RoFormer<a href="#ref"><sup>[12,16]</sup></a>。选择这两种预训练模型的原因是：</p>
<ol>
<li>两种模型都对位置编码(Position Embedding, PE)做了优化，其中NEZHA采用相对位置编码，RoFormer采用了旋转式位置编码，原文实验结果都表明了其有效性；</li>
<li>自注意力计算复杂度较高($O(n^2)$)，在预训练阶段为减少训练时间，设置的最大文本长度为128，而微调阶段使用数据增强时设置的最大文本长度为256。此时若采用可学习PE会导致128~256位置的参数学习不充分，而NEZHA和RoFormer的PE参数是固定无需学习的，不存此问题。</li>
</ol>
<p>&emsp; &emsp;另外，本文在句级表征获取方面进行了设计。用BERT类模型获取句级表征一般是通过特殊token<code>[CLS]</code>获取，也有部分方法通过对各输入token对应的编码特征进行池化操作得到句级表征，如均值池化、最大值池化、LSTM池化等。初赛阶段方案采用<code>[CLS]</code>对应编码输出作为句级表征，但后续实验发现<strong>为每个标签设置单独的表征</strong>能极大提升分类的性能，两者方案对比如下：</p>
<blockquote>
<p><strong>反直觉</strong>：微调过程中尝试多种方法建模标签间依赖都失效，如Self-Attention、GCN等，而将两个任务分开训练能得到更好的实验结果，也就是说区域预测与类型预测间没有较大的关联性，更有部分选手采用小型深度模型(如RNN)对各个标签单独建模。</p>
</blockquote>
<p><img src="//yoursite/Fig5_model1.png" alt="Fig5_model1"></p>
<p>同时，各标签间解耦也能提升模型的性能，通过修改<code>attention_mask</code>为以下形式实现，多头注意力每个头的注意力掩码一致</p>
<p><img src="//yoursite/Fig5_attention_mask.png" alt="Fig5_attention_mask"></p>
<h2 id="预训练"><a href="#预训练" class="headerlink" title="预训练"></a>预训练</h2><p>&emsp; &emsp;谷歌BERT模型预训练以自监督方式进行，进行的两个任务分别为token级的Masked Laguage Model(MLM)和句级的Next Sequence Prediction(NSP)<a href="#ref"><sup>[3]</sup></a>。此后大量研究对这方面进行了改进，即对预训练任务进行了调整，旨在提高模型的语义表达能力。在<strong>token级任务</strong>上，SpanBERT<a href="#ref"><sup>[13]</sup></a>期望模型能得到连续范围的预测输出，科大讯飞为中文文本处理提出了Whole Word Mask Language Model(wwm-MLM)任务<a href="#ref"><sup>[14]</sup></a>，取得了较为不错的实验结果，wwm-MLM与MLM的对比如下图所示。在<strong>句级分类任务</strong>上，RoBERTa<a href="#ref"><sup>[4]</sup></a>移除了NSP任务，仅保留MLM；ALBERT在BERT基础上，将NLP任务修改为Sentence Order Prediction(SOP)；苏剑林等人提出SimBERT<a href="#ref"><sup>[20]</sup></a>，将文本匹配的有监督信息用于预训练任务中。</p>
<p><img src="//yoursite/Fig4_wwm.png" alt="Fig4_wwm"></p>
<p>&emsp; &emsp;本方案预训练模型结构如下，在token级任务上采用了wwm-MLM任务，在句级任务上进行了创新。具体地，在同批次数据内对每个待预测标签进行匹配，如果两个样本具有相同标签，那么求取两者对应标签的句级编码的内积进行相似度匹配，利用二分类交叉熵计算匹配损失,如果样本属于测试集，无标签信息，那么不进行匹配。这样做的目的是希望将模型通过相似度匹配任务学习到的语义表达能力推广应用到分类任务中。</p>
<p><img src="//yoursite/Fig5_model2.png" alt="Fig5_model2"></p>
<p>具体例子如下，若读取的某批次(bs=8)数据的标签为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  | 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line">0 | 1  1  1  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0</span><br><span class="line">1 | 0  0  0  0  0  0  0  1  0  0  0  0  0  0  0  0  0  1  0  1  0  0  0  0  0  0  0  0  0</span><br><span class="line">2 | 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  1  0  0  0  0  0  0  0  0  0</span><br><span class="line">3 | 0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  0  0  0</span><br><span class="line">4 | 1  0  0  0  0  0  0  1  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  0</span><br><span class="line">5 |-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1</span><br><span class="line">6 | 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0</span><br><span class="line">7 | 0  0  0  0  1  0  0  0  0  0  0  1  0  0  0  0  0  0  0  1  0  0  0  0  0  0  0  0  0</span><br></pre></td></tr></table></figure><br>那么<strong>标签19</strong>的匹配标签矩阵，如下，其中<code>0</code>表示不匹配，<code>1</code>表示匹配，<code>-1</code>表示忽略(不计算损失)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  |  0  1  2  3  4  5  6  7</span><br><span class="line">---------------------------</span><br><span class="line">0 | -1  0  0  0  1 -1  1  0</span><br><span class="line">1 | -1 -1  1  1  0 -1  0  1</span><br><span class="line">2 | -1 -1 -1  1  0 -1  0  1</span><br><span class="line">3 | -1 -1 -1 -1  0 -1  0  1</span><br><span class="line">4 | -1 -1 -1 -1 -1 -1  1  0</span><br><span class="line">5 | -1 -1 -1 -1 -1 -1 -1 -1</span><br><span class="line">6 | -1 -1 -1 -1 -1 -1 -1  0</span><br><span class="line">7 | -1 -1 -1 -1 -1 -1 -1 -1</span><br></pre></td></tr></table></figure></p>
<p>存在的问题以及相应的解决方案：</p>
<ol>
<li>wwm-MLM需要使用分词信息得到词语的划分，而本赛题文本已脱敏化，解决方案是：<ul>
<li>为了能使用目前的分词工具，如jieba，首先将脱敏token映射为中文字符；</li>
<li>采用了新词发现算法寻找可能存在的由2~4个字组成的词语，仅保留了200个以减少噪声干扰。经统计发现词频最低的token组合是<code>830 290 724 486</code>，在语料中共出现18次，其余提取的词语出现次数都远大于该词，一定程度上验证了新词发现的有效性。</li>
</ul>
</li>
<li>这种预训练方案导致微调时验证集标签泄露，容易过拟合：重新初始化<code>[CLS 0]~[CLS n]</code>对应的嵌入向量；</li>
<li>当无标签数据过多时，单个批次内匹配的标签对比较稀疏，导致模型学习不充分：训练时减少无标签数据。</li>
</ol>
<p>&emsp; &emsp;模型参数量与BERT(base)一致(<code>L12_A12_H768</code>)，部分关键训练参数如下表。最终损失在0.1~0.3之间，该范围内的预训练模型对后续模型微调效果差距不大。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>初赛</th>
<th>复赛</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据文件</td>
<td>track1_round1_train_20210222.csv<br>track1_round1_testA_20210222.csv<br>track1_round1_testB.csv</td>
<td>track1_round1_train_20210222.csv<br>train.csv<br>testA/B.csv</td>
</tr>
<tr>
<td>batch matching</td>
<td>w/o</td>
<td>w/</td>
</tr>
<tr>
<td>mlm probability</td>
<td>0.3</td>
<td>0.2</td>
</tr>
<tr>
<td>learning rate</td>
<td>0.000176</td>
<td>0.000176</td>
</tr>
<tr>
<td>max sequence length</td>
<td>45(误)</td>
<td>128</td>
</tr>
<tr>
<td>batch size</td>
<td>256</td>
<td>64</td>
</tr>
<tr>
<td>warmup steps</td>
<td>500</td>
<td>5000</td>
</tr>
<tr>
<td>total steps</td>
<td>16000</td>
<td>90090</td>
</tr>
<tr>
<td>optimizer</td>
<td>AdamW</td>
<td>AdamW</td>
</tr>
<tr>
<td>scheduler</td>
<td>linear</td>
<td>linear</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
</div>
<h2 id="微调"><a href="#微调" class="headerlink" title="微调"></a>微调</h2><p>&emsp; &emsp;微调阶段模型比较简单，是在预训练模型基础上添加线性变换层进行二分类训练，即每个分类标签对应编码向量作Logistic回归，预测异常概率，如下图所示</p>
<p><img src="//yoursite/Fig5_model3.png" alt="Fig5_model3"></p>
<p>损失函数对不同样本重加权后取均值，见<a href="#样本重加权">样本重加权</a>。计算方法与指标计算保持一致。初赛阶段计算每个预测值的$\text{mlogloss}$，复赛阶段损失由两部分组成：</p>
<ul>
<li>第一部分（区域）损失$L_1$计算方式与初赛一致，对$N \times M_1$个预测值计算损失；</li>
<li>第二部分（类型）损失$L_2$对所有实际存在异常区域的测试样本计算$\text{mlogloss}$指标，例如$N$个样本中包含$K$个存在区域异常的样本，那么对$K \times M_2$个预测值计算$\text{mlogloss}$指标。</li>
</ul>
<p>最终复赛阶段损失为$L = 0.6 \times L_1 + 0.4 \times L_2$。一些部分关键训练参数范围如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>adv_epsilon</td>
<td>1.5 ~ 3.0</td>
</tr>
<tr>
<td>batch size</td>
<td>32</td>
</tr>
<tr>
<td>warmup ratio</td>
<td>0.1</td>
</tr>
<tr>
<td>learning_rate(bert)</td>
<td>2e-5, 3e-5, 5e-5</td>
</tr>
<tr>
<td>learning_rate(other)</td>
<td>1e-4 ~ 1e-3</td>
</tr>
<tr>
<td>epochs</td>
<td>3 ~ 4</td>
</tr>
<tr>
<td>optimizer</td>
<td>AdamW</td>
</tr>
<tr>
<td>scheduler</td>
<td>linear</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
</div>
<h1 id="模型集成"><a href="#模型集成" class="headerlink" title="模型集成"></a>模型集成</h1><p>&emsp; &emsp;这题模型集成带来的收益是极大的，如单个NEZHA模型在5折下LB为0.928+，加入RoFormer模型LB能达到0.934+，集成过程示意图如下。将训练数据$K$折划分，确定超参数范围后从中选择一组参数训练$K$个模型，每个模型在测试集上的结果取均值作为该组参数下的结果，反复多组参数训练并以<a href="#blending">Blending</a>组合多组参数的输出结果。但实际过程中发现，Blending求取的参数非常稀疏，许多参数都是0，因此最终采用均值集成。<br>&emsp; &emsp;复赛提交时，对数据进行5折划分，一共2个不同的模型，共设定6组训练参数，两个任务分别训练，对单个任务来说共$2 \times 5 \times 6 = 60$个模型集成。</p>
<p><img src="//yoursite/Fig7_ensemble1.png" alt="Fig7_ensemble1"></p>
<h1 id="方案优化"><a href="#方案优化" class="headerlink" title="方案优化"></a>方案优化</h1><div class="table-container">
<table>
<thead>
<tr>
<th>优化方向</th>
<th>方法</th>
<th>说明</th>
<th>是否有效</th>
<th>原因分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据</td>
<td>数据增强——CutMix</td>
<td>从训练样本集中随机选择两个原始样本，随机打乱顺序后拼接得到扩增样本，并将两个原始样本的标签进行合并</td>
<td>是</td>
<td>扩增样本集</td>
</tr>
<tr>
<td>数据</td>
<td>数据增强——EDA</td>
<td>随机替换、删除、交换、插入其他token</td>
<td>否</td>
<td>因数据集而异</td>
</tr>
<tr>
<td>数据</td>
<td>样本重加权</td>
<td>用训练集样本和测试集样本相似度计算权重，减少样本分布不一致</td>
<td>是</td>
<td>一定程度上对齐训练集与测试集</td>
</tr>
<tr>
<td>数据</td>
<td>多标签分层K折划分</td>
<td>使每折中各类标签分布一致，避免改变样本集分布</td>
<td>是</td>
<td>减少样本分布不一致问题的影响</td>
</tr>
<tr>
<td>模型</td>
<td>设置分类标签嵌入</td>
<td>为每个标签设置嵌入向量，并优化注意力掩码矩阵</td>
<td>是</td>
<td>使多标签间解耦</td>
</tr>
<tr>
<td>模型</td>
<td>复用公开预训练模型权重</td>
<td>考虑BERT模型的编码器可能包含较强的语义编码能力，因此尝试在模型预训练阶段复用公开预训练模型权重。具体地，载入预训练模型的编码器部分权重、重新初始化嵌入层参数，在此基础上进行Mask Language Model训练</td>
<td>否</td>
<td>可能是BERT编码器与嵌入层参数间存在较大的耦合性</td>
</tr>
<tr>
<td>模型</td>
<td>更多特征</td>
<td>加入其他句级特征，如Word2Vec、TFIDF特征</td>
<td>否</td>
<td>低阶特征对性能影响不大</td>
</tr>
<tr>
<td>模型</td>
<td>句级特征正态分布约束</td>
<td>BERT模型获取的编码特征存在各向异性，添加句级特征正态分布约束来改进，思路来源BERT-flow</td>
<td>否</td>
<td>太多的限制对模型参数优化不佳</td>
</tr>
<tr>
<td>损失</td>
<td>损失计算改进</td>
<td>复赛阶段损失分为两部分计算</td>
<td>是</td>
<td>损失计算和指标计算一致</td>
</tr>
<tr>
<td>损失</td>
<td>Label Smoothing</td>
<td>对标签进行一定程度的平滑</td>
<td>否</td>
<td>评估指标较为严格，若以准确率为指标可能会有提升</td>
</tr>
<tr>
<td>损失</td>
<td>Focal Loss</td>
<td>调整α参数进行困难样本挖掘，调整γ参数增大正样本权重</td>
<td>否</td>
<td>评估指标较为严格，若以准确率为指标可能会有提升</td>
</tr>
<tr>
<td>损失</td>
<td>Asymmetric Loss</td>
<td>基于Focal Loss提出的用于多标签分类的非对称损失</td>
<td>否</td>
<td>参数调整不佳</td>
</tr>
<tr>
<td>损失</td>
<td>负样本采样</td>
<td>各标签正负样本存在严重的类别不平衡问题，希望通过负样本采样来平衡</td>
<td>否</td>
<td>验证集上正样本分数提升但负样本分数下降，由于负样本更多导致总体分数下降</td>
</tr>
<tr>
<td>学习策略</td>
<td>对抗训练</td>
<td>微调训练过程中使用了FGM对抗学习<a href="#ref"><sup>[17,18]</sup></a>，即对词向量添加一定的扰动生成对抗样本，也可以视作数据增强</td>
<td>是</td>
<td>扩增样本集、增强模型鲁棒性</td>
</tr>
<tr>
<td>学习策略</td>
<td>学习率衰减策略</td>
<td>如余弦衰减、线性衰减</td>
<td>线性衰减有效</td>
<td>因数据集而异</td>
</tr>
<tr>
<td>学习策略</td>
<td>半监督学习</td>
<td>利用无标签数据训练，详情见<a href="#半监督学习">半监督学习</a></td>
<td>初赛阶段提升结果较大，但复赛阶段无效</td>
<td>未知</td>
</tr>
<tr>
<td>学习策略</td>
<td>伪标签</td>
<td>半监督的一种，用训练好的模型在测试上获取标签，标签预测概率较高的样本用作测试集</td>
<td>否</td>
<td>受模型性能影响，噪声较大</td>
</tr>
<tr>
<td>其他</td>
<td>略</td>
<td>略</td>
<td>略</td>
<td>略</td>
</tr>
</tbody>
</table>
</div>
<h1 id="大赛结果"><a href="#大赛结果" class="headerlink" title="大赛结果"></a>大赛结果</h1><p><img src="//yoursite/Fig6_res1.png" alt="Fig6_res1"><br><img src="//yoursite/Fig6_res2.png" alt="Fig6_res2"></p>
<h1 id="Top方案"><a href="#Top方案" class="headerlink" title="Top方案"></a>Top方案</h1><p>&emsp; &emsp;<br>TODO:</p>
<h1 id="不足与展望"><a href="#不足与展望" class="headerlink" title="不足与展望"></a>不足与展望</h1><ol>
<li>在模型方面，BERT模型的多头注意力机制关注的是全局特征，ConvBERT<a href="#ref"><sup>[15]</sup></a>也提出其中部分头是冗余的，考虑是否能通过修改<code>attention_mask</code>使模型获取到局部的语义信息，这种方式比ConvBERT更简单；</li>
<li>微调的分类损失函数采用交叉熵，没有尝试其他原理上较为不同的损失函数，如Soft-F1<a href="#ref"><sup>[19]</sup></a>；</li>
<li>数据增强方面，受Mixup启发，可以将两句输入的词向量和标签加权累加获得扩增样本，有效性待确定；</li>
<li>大赛要求复赛LB能复现，导致复赛A榜调试时过度关注全流程问题，影响有效调参次数(每日限制提交3次，但实际最多提交2次)，需做好时间安排；</li>
<li>在实验调参过程中，必须做好消融实验，保存各种日志，另外妥善修改代码确保各版本稳定可复现；</li>
</ol>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><div id="ref"></div>

<p>[1] <a href="https://arxiv.org/abs/1905.04899v2" target="_blank" rel="noopener">Yun S ,  Han D ,  Oh S J , et al. CutMix: Regularization Strategy to Train Strong Classifiers with Localizable Features[J].  2019.</a><br>[2] <a href="https://arxiv.org/abs/1901.11196" target="_blank" rel="noopener">Wei J ,  Zou K . EDA: Easy Data Augmentation Techniques for Boosting Performance on Text Classification Tasks[J].  2019.</a><br>[3] <a href="https://arxiv.org/abs/1810.04805" target="_blank" rel="noopener">Devlin J ,  Chang M W ,  Lee K , et al. BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding[J].  2018.</a><br>[4] <a href="http://arxiv.org/abs/1907.11692v1" target="_blank" rel="noopener">Liu Y ,  Ott M ,  Goyal N , et al. RoBERTa: A Robustly Optimized BERT Pretraining Approach[J].  2019.</a><br>[5] <a href="https://arxiv.org/abs/1906.08237" target="_blank" rel="noopener">Yang Z ,  Dai Z ,  Yang Y , et al. XLNet: Generalized Autoregressive Pretraining for Language Understanding[J].  2019.</a><br>[6] <a href="http://arxiv.org/abs/2005.14165" target="_blank" rel="noopener">Brown T B ,  Mann B ,  Ryder N , et al. Language Models are Few-Shot Learners[J].  2020.</a><br>[7] <a href="http://arxiv.org/abs/2002.10957" target="_blank" rel="noopener">Wang W ,  Wei F ,  Dong L , et al. MiniLM: Deep Self-Attention Distillation for Task-Agnostic Compression of Pre-Trained Transformers[J].  2020.</a><br>[8] <a href="http://arxiv.org/abs/1905.03197" target="_blank" rel="noopener">Dong L ,  Yang N ,  Wang W , et al. Unified Language Model Pre-training for Natural Language Understanding and Generation[J].  2019.</a><br>[9] <a href="http://arxiv.org/abs/2002.12804v1" target="_blank" rel="noopener">Bao H ,  Dong L ,  Wei F , et al. UniLMv2: Pseudo-Masked Language Models for Unified Language Model Pre-Training[J].  2020.</a><br>[10] <a href="http://arxiv.org/abs/1905.07129v1" target="_blank" rel="noopener">Zhang Z ,  Han X ,  Liu Z , et al. ERNIE: Enhanced Language Representation with Informative Entities[C]// Proceedings of the 57th Annual Meeting of the Association for Computational Linguistics. 2019.</a><br>[11] <a href="http://arxiv.org/abs/1909.00204" target="_blank" rel="noopener">Wei J ,  Ren X ,  Li X , et al. NEZHA: Neural Contextualized Representation for Chinese Language Understanding[J].  2019.</a><br>[12] <a href="http://www.researchgate.net/publication/351019664_RoFormer_Enhanced_Transformer_with_Rotary_Position_Embedding" target="_blank" rel="noopener">Su J ,  Lu Y ,  Pan S , et al. RoFormer: Enhanced Transformer with Rotary Position Embedding.  2021.</a><br>[13] <a href="http://www.researchgate.net/publication/339887954_SpanBERT_Improving_Pre-training_by_Representing_and_Predicting_Spans/download" target="_blank" rel="noopener">Joshi M ,  Chen D ,  Liu Y , et al. SpanBERT: Improving Pre-training by Representing and Predicting Spans[J]. Transactions of the Association for Computational Linguistics, 2020, 8:64-77.</a><br>[14] <a href="https://arxiv.org/abs/1906.08101v2" target="_blank" rel="noopener">Cui Y ,  Che W ,  Liu T , et al. Pre-Training with Whole Word Masking for Chinese BERT[J].  2019.</a><br>[15] <a href="http://arxiv.org/abs/2008.02496" target="_blank" rel="noopener">Jiang Z ,  Yu W ,  Zhou D , et al. ConvBERT: Improving BERT with Span-based Dynamic Convolution[J].  2020.</a><br>[16] <a href="https://www.kexue.fm/archives/8265" target="_blank" rel="noopener">Transformer升级之路：2、博采众长的旋转式位置编码 - 科学空间</a><br>[17] <a href="https://zhuanlan.zhihu.com/p/103593948" target="_blank" rel="noopener">一文搞懂NLP中的对抗训练FGSM/FGM/PGD/FreeAT/YOPO/FreeLB/SMART - 知乎</a><br>[18] <a href="https://blog.csdn.net/xixiaoyaoww/article/details/104851198" target="_blank" rel="noopener">对抗学习在NLP中的应用 - 夕小瑶/CSDN</a><br>[19] <a href="https://towardsdatascience.com/the-unknown-benefits-of-using-a-soft-f1-loss-in-classification-systems-753902c0105d" target="_blank" rel="noopener">The Unknown Benefits of using a Soft-F1 Loss in Classification Systems - towardsdatascience.com/</a><br>[20] <a href="https://spaces.ac.cn/archives/7427" target="_blank" rel="noopener">鱼与熊掌兼得：融合检索和生成的SimBERT模型</a></p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="半监督学习"><a href="#半监督学习" class="headerlink" title="半监督学习"></a>半监督学习</h2><p>&emsp; &emsp;考虑到伪标签半监督方法存在以下两个问题：1) 严重依赖输出测试集预测的模型的性能；2) 以两阶段的形式进行，同时训练时间较长。本文设计了一种端到端的半监督学习方法。具体地，在训练时训练集数据(有标签)与测试集数据(无标签)同时读取到某个批次中，模型对该批次前向推断计算每个样本每个标签的概率输出。设定阈值$t, 0 \leq t \leq 1$，将无标签数据预测结果中大于$t$的作为正样本，小于$(1 - t)$的作为负样本，这些被标记的预测输出与有标签数据同时计算损失。另外，为了减少错误预测带来的噪声影响，这些被标记的无标签样本计算损失时，真实值采用模型输出的概率值，而不是0或1的取值。</p>
<h2 id="Blending"><a href="#Blending" class="headerlink" title="Blending"></a>Blending</h2><p>&emsp; &emsp;设定某组训练参数$p$下，进行$K$折模型训练得到$K$个模型，每个模型对其验证集数据进行推断，得到相应的验证集输出$\tilde{y}_{k}^{p}$，将${\tilde{y}_{1}^{p}, \tilde{y}_{2}^{p}, \tilde{y}_{3}^{p}, \tilde{y}_{4}^{p}, \tilde{y}_{5}^{p}}$合并后得到推断输出$\tilde{y}^{p}$，该输出集可以视作改组参数对训练集的推断结果，由$M$组参数${p_1, p_2, \cdots, p_M}$分别得到的结果计算加权参数。</p>
<p>&emsp; &emsp;假设共$N$个训练集样本，在$M$组参数下训练得到$M$个输出结果，初始化参数$w_1, w_2, \cdots, w_M$，设定优化目标为</p>
<script type="math/tex; mode=display">
\begin{aligned}
    J(w) \quad & = \min_{w_1, w_2, \cdots, w_M} \frac{1}{N} \sum_{i=1}^N \text{score}(
        y_i, \frac{1}{M} \sum_{j=1}^M w_j \tilde{y}_i^{p_j}
    ) \\
    s.t. \quad & \sum_{j=1}^M w_j = 1 \\
         & 0 \leq w_j \leq 1, j = 1, \cdots, M
\end{aligned}</script><p>其中$\text{score}(\cdot)$是评估函数，分数越小表示集成效果越好。</p>

      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Louis Hsu 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Competition/" rel="tag"># Competition</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/03/24/BERT-flow/" rel="next" title="BERT-flow">
                <i class="fa fa-chevron-left"></i> BERT-flow
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="Louis Hsu" />
            
              <p class="site-author-name" itemprop="name">Louis Hsu</p>
              <p class="site-description motion-element" itemprop="description">ᵕ᷄ ≀ ̠˘᷅ 永远年轻，永远热泪盈眶</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/%20%7C%7C%20archive">
                
                    <span class="site-state-item-count">116</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/isLouisHsu" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://is.louishsu@foxmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/islouishsu" target="_blank" title="Zhihu"><i class="fa fa-fw fa-zhihu"></i>Zhihu</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/islouishsu" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          <div id='music163player'>
            <iframe 
              frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 
              src="//music.163.com/outchain/player?type=0&id=2703291040&auto=1&height=90">
            </iframe>
          </div>

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目录"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#赛题介绍"><span class="nav-number">2.</span> <span class="nav-text">赛题介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#赛题背景"><span class="nav-number">2.1.</span> <span class="nav-text">赛题背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#赛题描述"><span class="nav-number">2.2.</span> <span class="nav-text">赛题描述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#赛题数据"><span class="nav-number">2.2.1.</span> <span class="nav-text">赛题数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提交要求"><span class="nav-number">2.2.2.</span> <span class="nav-text">提交要求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#评估标准"><span class="nav-number">2.2.3.</span> <span class="nav-text">评估标准</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#赛题思路"><span class="nav-number">2.3.</span> <span class="nav-text">赛题思路</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据处理"><span class="nav-number">3.</span> <span class="nav-text">数据处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#探索分析"><span class="nav-number">3.1.</span> <span class="nav-text">探索分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据划分"><span class="nav-number">3.2.</span> <span class="nav-text">数据划分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#样本重加权"><span class="nav-number">3.3.</span> <span class="nav-text">样本重加权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据增强"><span class="nav-number">3.4.</span> <span class="nav-text">数据增强</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模型训练"><span class="nav-number">4.</span> <span class="nav-text">模型训练</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型结构"><span class="nav-number">4.1.</span> <span class="nav-text">模型结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#预训练"><span class="nav-number">4.2.</span> <span class="nav-text">预训练</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#微调"><span class="nav-number">4.3.</span> <span class="nav-text">微调</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模型集成"><span class="nav-number">5.</span> <span class="nav-text">模型集成</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#方案优化"><span class="nav-number">6.</span> <span class="nav-text">方案优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#大赛结果"><span class="nav-number">7.</span> <span class="nav-text">大赛结果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Top方案"><span class="nav-number">8.</span> <span class="nav-text">Top方案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#不足与展望"><span class="nav-number">9.</span> <span class="nav-text">不足与展望</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文献"><span class="nav-number">10.</span> <span class="nav-text">参考文献</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录"><span class="nav-number">11.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#半监督学习"><span class="nav-number">11.1.</span> <span class="nav-text">半监督学习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Blending"><span class="nav-number">11.2.</span> <span class="nav-text">Blending</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Louis Hsu</span>

  

  
</div>











        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  



  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  



  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'e65d27f7cf5c62feaf97',
          clientSecret: '356386826698e8b817ca076b08d7c0e9814f52ea',
          repo: 'isLouisHsu.github.io',
          owner: 'isLouisHsu',
          admin: ['isLouisHsu'],
          id: md5(window.location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')
       </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('3');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>



  <script type="text/javascript" src="/js/click_show_text.js"></script>
  <script type="text/javascript" src="/js/hone_hone_clock.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>
